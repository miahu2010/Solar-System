<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Solar Dust V - Ethereal Mist</title>
    <style>
        :root {
            --bg-color: #050505;
            --glass-bg: rgba(20, 20, 20, 0.4); /* 更淡的玻璃 */
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #e0e0e0;
            --text-sub: #888;
            --accent: #ffffff; /* 纯白点缀，极简 */
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-main);
        }

        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; }
        #input-video { display: none; }

        /* UI 设计：极简、纤细 */
        .ui-layer { position: absolute; pointer-events: none; z-index: 10; width: 100%; height: 100%; }

        .glass-panel {
            pointer-events: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 20px;
            transition: opacity 0.5s ease;
        }

        /* 左侧列表 */
        #sidebar { position: absolute; top: 30px; left: 30px; width: 200px; }
        
        h2 {
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub);
            margin: 0 0 15px 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px;
        }

        .nav-item {
            font-size: 13px; color: var(--text-sub); padding: 8px 0; cursor: pointer;
            transition: all 0.3s; display: flex; justify-content: space-between;
            border-bottom: 1px solid transparent;
        }
        .nav-item:hover { color: #fff; }
        .nav-item.active { color: #fff; border-bottom: 1px solid #fff; }
        .nav-icon { font-size: 8px; opacity: 0.5; display: grid; place-items: center; }

        /* 右侧信息：悬浮卡片 */
        #info-card {
            position: absolute; bottom: 40px; right: 40px; width: 260px;
            opacity: 0; transform: translateY(20px); transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        #info-card.visible { opacity: 1; transform: translateY(0); }

        .planet-name { font-size: 32px; font-weight: 200; letter-spacing: 4px; margin: 0; color: #fff; }
        .planet-type { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub); margin-bottom: 15px; display: block; }
        .planet-desc { font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.7); font-weight: 300; }
        
        .data-row { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid var(--glass-border); padding-top: 10px; }
        .data-box span { display: block; }
        .d-label { font-size: 9px; color: var(--text-sub); letter-spacing: 1px; }
        .d-value { font-size: 14px; font-weight: 300; margin-top: 2px; }

        /* 状态指示 */
        #status-bar {
            position: absolute; bottom: 30px; left: 30px; font-size: 10px; color: var(--text-sub);
            display: flex; gap: 15px; align-items: center;
        }
        .status-dot { width: 6px; height: 6px; background: #333; border-radius: 50%; transition: 0.3s; }
        .status-dot.active { background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* 开场 */
        #cover {
            position: fixed; inset: 0; background: #050505; z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s;
        }
        button.start {
            background: none; border: 1px solid rgba(255,255,255,0.3); color: #fff;
            padding: 12px 30px; font-size: 11px; letter-spacing: 3px; cursor: pointer;
            transition: 0.3s; border-radius: 20px;
        }
        button.start:hover { border-color: #fff; background: rgba(255,255,255,0.05); }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="cover">
        <h1 style="font-weight: 200; font-size: 24px; letter-spacing: 8px; margin-bottom: 30px; opacity: 0.8;">SOLAR MIST</h1>
        <button class="start" id="btn-start">EXPLORE</button>
    </div>

    <div class="ui-layer">
        <div id="sidebar" class="glass-panel">
            <h2>System</h2>
            <div id="nav-list"></div>
        </div>

        <div id="info-card" class="glass-panel">
            <h1 class="planet-name" id="ui-name">EARTH</h1>
            <span class="planet-type" id="ui-type">TERRESTRIAL</span>
            <p class="planet-desc" id="ui-desc">Our home planet.</p>
            <div class="data-row">
                <div class="data-box">
                    <span class="d-label">DIAMETER</span>
                    <span class="d-value" id="ui-dia">12,742</span>
                </div>
                <div class="data-box">
                    <span class="d-label">TEMP</span>
                    <span class="d-value" id="ui-temp">15°C</span>
                </div>
            </div>
        </div>

        <div id="status-bar">
            <div style="display:flex; align-items:center; gap:6px;">
                <div class="status-dot" id="cam-dot"></div>
                <span id="cam-text">VISION OFF</span>
            </div>
            <span>|</span>
            <span>GESTURE: OPEN TO DISSOLVE / FIST TO FORM</span>
        </div>
    </div>

    <video id="input-video"></video>
    <div id="canvas-container"></div>

    <script type="x-shader/x-vertex" id="vShader">
        attribute float size;
        attribute float shift; // 随机偏移量
        
        uniform float uTime;
        uniform float uFist; // 0.0 (弥散/雾化) -> 1.0 (实体/球形)
        
        varying vec3 vColor;
        varying float vAlpha;

        void main() {
            vColor = color;
            vec3 p = position;
            
            // --- 核心逻辑：优雅的聚合 ---
            
            // 1. 弥散态 (Mist State): 
            // 粒子根据 shift 属性向外扩散，形成无序的云雾
            vec3 mistPos = normalize(p) * (length(p) * (2.0 + shift * 2.0)); 
            
            // 2. 浮动动画 (Floating):
            // 无论什么状态，粒子都在微微浮动，像尘埃一样
            float t = uTime * 0.2;
            float wave = sin(t + shift * 10.0) * 0.5; // 轻微的波浪
            
            // 3. 混合位置
            // uFist = 0 (张手): 显示 mistPos (云雾)
            // uFist = 1 (握拳): 显示 position (完美的球体)
            // 使用 smoothstep 让过渡更柔和
            float mixFactor = smoothstep(0.0, 1.0, uFist);
            
            // 最终位置：在 云雾 和 球体 之间插值，并加上微小的浮动
            vec3 finalPos = mix(mistPos, p, mixFactor);
            finalPos += normalize(p) * wave * (1.0 - mixFactor * 0.8); // 球体状态下浮动减小

            vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
            
            // 大小：球体状态下粒子更小更密，云雾状态下粒子大且虚
            float currentSize = size * (2.0 - mixFactor); 
            
            gl_PointSize = currentSize * (150.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;

            // 透明度：云雾状态下更透明
            vAlpha = 0.4 + mixFactor * 0.6;
        }
    </script>

    <script type="x-shader/x-fragment" id="fShader">
        uniform sampler2D pointTexture;
        varying vec3 vColor;
        varying float vAlpha;
        
        void main() {
            vec2 coord = gl_PointCoord - vec2(0.5);
            float dist = length(coord);
            if(dist > 0.5) discard;

            // 极度柔和的光晕
            float glow = 1.0 - smoothstep(0.0, 0.5, dist);
            glow = pow(glow, 1.5); // 稍微锐化一点核心

            // 颜色：使用纯加法混合，无需计算光照，性能最好
            gl_FragColor = vec4(vColor, vAlpha * glow);
        }
    </script>

    <script>
        // --- 莫兰迪色系配置 (低饱和，高级灰) ---
        const PLANETS = [
            { name: "Sun", type: "Star", color: [1.0, 0.9, 0.8], radius: 12, dist: 0, speed: 0, 
              desc: "The quiet heart. A glowing sphere of warm plasma.", data: {d:"1.39M km", t:"5500°C"} },
            { name: "Mercury", type: "Terrestrial", color: [0.7, 0.7, 0.7], radius: 2, dist: 25, speed: 0.8, 
              desc: "A grey, silent rock close to the light.", data: {d:"4,879 km", t:"167°C"} },
            { name: "Venus", type: "Terrestrial", color: [0.85, 0.8, 0.7], radius: 3.5, dist: 40, speed: 0.6, 
              desc: "Veiled in pale clouds.", data: {d:"12,104 km", t:"464°C"} },
            { name: "Earth", type: "Habitable", color: [0.3, 0.5, 0.7], radius: 3.8, dist: 60, speed: 0.5, 
              desc: "A pale blue dot suspended in a sunbeam.", data: {d:"12,742 km", t:"15°C"} },
            { name: "Mars", type: "Terrestrial", color: [0.8, 0.5, 0.4], radius: 2.5, dist: 80, speed: 0.4, 
              desc: "Dusty rust frozen in time.", data: {d:"6,779 km", t:"-65°C"} },
            { name: "Jupiter", type: "Gas Giant", color: [0.7, 0.65, 0.6], radius: 9, dist: 110, speed: 0.2, 
              desc: "The gentle giant protecting the void.", data: {d:"139k km", t:"-110°C"} },
            { name: "Saturn", type: "Gas Giant", color: [0.8, 0.75, 0.6], radius: 8, dist: 140, speed: 0.15, hasRing: true,
              desc: "Adorned with rings of ice crystals.", data: {d:"116k km", t:"-140°C"} },
            { name: "Uranus", type: "Ice Giant", color: [0.6, 0.7, 0.8], radius: 6, dist: 170, speed: 0.1, 
              desc: "A cold, pale cyan mist.", data: {d:"50,724 km", t:"-195°C"} },
            { name: "Neptune", type: "Ice Giant", color: [0.4, 0.5, 0.8], radius: 6, dist: 200, speed: 0.08, 
              desc: "Deep blue silence at the edge.", data: {d:"49,244 km", t:"-200°C"} }
        ];

        let scene, camera, renderer, controls;
        let uniforms;
        let planetGroups = []; // 公转组
        let planetMeshes = []; // 粒子本体
        let activeIndex = -1;
        
        // 状态
        let state = {
            fist: 0.5, // 初始半聚合状态，比较好看
            targetFist: 0.5,
            camPos: new THREE.Vector3(0, 100, 200)
        };

        // --- 初始化 ---
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('cover').style.opacity = 0;
            setTimeout(() => document.getElementById('cover').style.display = 'none', 1000);
            initCamera();
            init3D();
        });

        function init3D() {
            const container = document.getElementById('canvas-container');
            
            // 场景
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.002); // 黑色雾气增加深邃感

            // 相机
            camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.set(0, 100, 200);
            
            // 渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x050505);
            container.appendChild(renderer.domElement);

            // 控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enablePan = false;
            controls.minDistance = 10;
            controls.maxDistance = 500;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // 粒子系统
            uniforms = {
                uTime: { value: 0 },
                uFist: { value: 0.5 },
                pointTexture: { value: createMistTexture() }
            };

            // 创建星空背景 (静态粒子，高性能)
            createStars();

            // 创建行星
            PLANETS.forEach((p, i) => createPlanet(p, i));

            // 创建UI
            createUI();

            // 动画循环
            animate();
            window.addEventListener('resize', onResize);
        }

        // --- 优化的粒子创建 ---
        function createPlanet(data, index) {
            // Pivot 用于公转
            const pivot = new THREE.Group();
            scene.add(pivot);

            // 粒子数量适中，追求性能
            const count = data.name === "Sun" ? 4000 : 1500;
            const geom = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];
            const shifts = [];

            const colorBase = new THREE.Color(data.color[0], data.color[1], data.color[2]);
            const hsl = {}; colorBase.getHSL(hsl);

            for(let i=0; i<count; i++) {
                // 球体分布
                const r = data.radius * Math.pow(Math.random(), 0.5); // 更均匀
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(Math.random() * 2 - 1);
                
                positions.push(
                    r * Math.sin(phi) * Math.cos(theta),
                    r * Math.sin(phi) * Math.sin(theta),
                    r * Math.cos(phi)
                );

                // 颜色：低饱和度变奏
                const c = new THREE.Color().setHSL(hsl.h, hsl.s * 0.8, hsl.l + (Math.random()-0.5)*0.2);
                colors.push(c.r, c.g, c.b);

                sizes.push(Math.random() * 1.5 + 0.5);
                shifts.push(Math.random());
            }

            // 土星环
            if(data.hasRing) {
                for(let i=0; i<600; i++) {
                    const r = data.radius * (1.5 + Math.random());
                    const theta = Math.random() * Math.PI * 2;
                    positions.push(r*Math.cos(theta), (Math.random()-0.5)*0.2, r*Math.sin(theta));
                    colors.push(0.7, 0.7, 0.65);
                    sizes.push(0.6);
                    shifts.push(Math.random());
                }
            }

            geom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geom.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geom.setAttribute('shift', new THREE.Float32BufferAttribute(shifts, 1));

            const mat = new THREE.ShaderMaterial({
                uniforms: uniforms,
                vertexShader: document.getElementById('vShader').textContent,
                fragmentShader: document.getElementById('fShader').textContent,
                blending: THREE.AdditiveBlending, // 加法混合让重叠处发光
                depthTest: false,
                transparent: true
            });

            const mesh = new THREE.Points(geom, mat);
            mesh.position.x = data.dist; // 初始位置
            pivot.add(mesh);

            // 保存引用
            planetGroups.push({ pivot, speed: data.speed, dist: data.dist });
            planetMeshes.push(mesh);

            // 极简轨道线 (更细、更淡)
            if(data.dist > 0) {
                const orbitGeo = new THREE.RingGeometry(data.dist-0.1, data.dist+0.1, 128);
                orbitGeo.rotateX(-Math.PI/2);
                const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.03, side: THREE.DoubleSide });
                scene.add(new THREE.Mesh(orbitGeo, orbitMat));
            }
        }

        function createStars() {
            const geom = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<2000; i++) {
                const r = 400 + Math.random()*200;
                const theta = Math.random()*Math.PI*2;
                const phi = Math.acos(Math.random()*2-1);
                pos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
            }
            geom.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({color:0x555555, size:1, transparent:true, opacity:0.6});
            scene.add(new THREE.Points(geom, mat));
        }

        function createMistTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,0.8)'); // 中心不那么刺眼
            g.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
            return new THREE.Texture(c);
        }

        // --- 逻辑控制 ---
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;
            uniforms.uTime.value = time;
            TWEEN.update();

            // 手势插值 (平滑过渡)
            state.fist += (state.targetFist - state.fist) * 0.05;
            uniforms.uFist.value = state.fist;

            // 公转
            planetGroups.forEach(g => {
                g.pivot.rotation.y += g.speed * 0.001; // 极慢的公转
            });

            // 镜头跟随
            if(activeIndex !== -1) {
                const mesh = planetMeshes[activeIndex];
                const worldPos = new THREE.Vector3();
                mesh.getWorldPosition(worldPos);
                controls.target.lerp(worldPos, 0.1); // 平滑锁定
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function focusPlanet(index) {
            activeIndex = index;
            const card = document.getElementById('info-card');
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(n => n.classList.remove('active'));
            
            if(index === -1) {
                // Overview
                card.classList.remove('visible');
                controls.autoRotate = true;
                navItems[0].classList.add('active');
                
                // 相机拉远
                new TWEEN.Tween(camera.position)
                    .to({x:0, y:100, z:200}, 1500)
                    .easing(TWEEN.Easing.Quadratic.Out)
                    .start();
                new TWEEN.Tween(controls.target)
                    .to({x:0, y:0, z:0}, 1500)
                    .start();
            } else {
                // Focus
                document.getElementById(`nav-${index}`).classList.add('active');
                controls.autoRotate = false; // 停止自动旋转，让用户自己看
                
                // 更新信息
                const p = PLANETS[index];
                document.getElementById('ui-name').innerText = p.name.toUpperCase();
                document.getElementById('ui-type').innerText = p.type;
                document.getElementById('ui-desc').innerText = p.desc;
                document.getElementById('ui-dia').innerText = p.data.d;
                document.getElementById('ui-temp').innerText = p.data.t;
                card.classList.add('visible');

                // 镜头飞入
                const mesh = planetMeshes[index];
                const worldPos = new THREE.Vector3();
                mesh.getWorldPosition(worldPos);
                
                // 计算一个舒服的观察位置 (侧上方)
                const offset = worldPos.clone().normalize().multiplyScalar(p.radius * 4 + 20);
                // 确保相机位置是相对于该星球的
                // 这一步比较复杂因为星球在动，这里我们只是给一个初始飞入点
                // 之后的帧会通过 controls.target 锁定
                
                // 简单的飞入动画，不完全锁死相机位置，只锁死Target
                // 这样保留了用户旋转查看的能力
                // 我们不移动相机到绝对位置，只缩放距离
            }
        }

        // --- UI ---
        function createUI() {
            const list = document.getElementById('nav-list');
            
            // Overview
            const itemAll = document.createElement('div');
            itemAll.className = 'nav-item active';
            itemAll.innerHTML = `<span>Overview</span><span class="nav-icon">●</span>`;
            itemAll.onclick = () => focusPlanet(-1);
            list.appendChild(itemAll);

            PLANETS.forEach((p, i) => {
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.id = `nav-${i}`;
                item.innerHTML = `<span>${p.name}</span><span class="nav-icon">○</span>`;
                item.onclick = () => focusPlanet(i);
                list.appendChild(item);
            });
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- MediaPipe (手势) ---
        async function initCamera() {
            const video = document.getElementById('input-video');
            const dot = document.getElementById('cam-dot');
            const txt = document.getElementById('cam-text');
            
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
            
            hands.onResults(results => {
                if(results.multiHandLandmarks.length > 0) {
                    dot.classList.add('active');
                    txt.innerText = "LINKED";
                    
                    const lm = results.multiHandLandmarks[0];
                    // 简单的张开/握拳检测
                    const wrist = lm[0];
                    const tip = lm[12]; // 中指尖
                    const base = lm[9]; // 中指根
                    
                    const dTip = Math.hypot(tip.x-wrist.x, tip.y-wrist.y);
                    const dBase = Math.hypot(base.x-wrist.x, base.y-wrist.y);
                    
                    if (dTip < dBase * 1.1) {
                        state.targetFist = 1.0; // 握拳 -> 实体
                    } else {
                        state.targetFist = 0.0; // 张开 -> 雾化
                    }
                } else {
                    dot.classList.remove('active');
                    txt.innerText = "SEARCHING";
                    state.targetFist = 0.5; // 默认半透明
                }
            });

            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            cam.start();
        }
    </script>
</body>
</html>
