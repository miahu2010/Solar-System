<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Solar Dust XXI - Robust Start</title>
    <style>
        :root{--bg:#000;--p:rgba(20,20,20,0.6);--b:rgba(255,255,255,0.15);--w:#fff}
        body,html{margin:0;padding:0;width:100%;height:100%;background:var(--bg);overflow:hidden;font-family:"Segoe UI",sans-serif;user-select:none;-webkit-user-select:none}
        #canvas-container{position:absolute;inset:0;z-index:1}
        #input-video{position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;pointer-events:none;z-index:-1}
        .ui{position:absolute;z-index:10;width:100%;height:100%;pointer-events:none;color:#ccc}
        .panel{pointer-events:auto;background:var(--p);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--b);border-radius:6px}
        
        /* 导航 */
        #nav{position:absolute;top:20px;left:20px;width:130px;max-height:50vh;overflow-y:auto;padding:5px}
        .btn{display:block;width:100%;background:0;border:0;color:#888;text-align:left;padding:10px 8px;cursor:pointer;font-size:11px;transition:0.2s;border-radius:4px;border-bottom:1px solid rgba(255,255,255,0.05)}
        .btn.active{color:var(--w);font-weight:700;background:rgba(255,255,255,0.1);border-left:3px solid var(--w)}
        
        /* 语言 */
        #lang-box{position:absolute;top:20px;right:20px;pointer-events:auto;display:flex;background:var(--p);padding:4px;border-radius:20px;border:1px solid var(--b)}
        .l-btn{background:0;border:0;color:#888;font-size:10px;cursor:pointer;padding:6px 10px;border-radius:16px;position:relative;z-index:2;transition:0.3s}
        .l-btn.active{color:#000;font-weight:700}
        #l-slider{position:absolute;top:4px;left:4px;height:calc(100% - 8px);background:var(--w);border-radius:16px;z-index:1;transition:0.3s cubic-bezier(0.25,0.8,0.25,1);width:0}

        /* 仪表盘 */
        #hud{position:absolute;bottom:30px;left:50%;transform:translate(-50%);width:280px;background:rgba(0,0,0,0.8);border:1px solid var(--b);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:6px;backdrop-filter:blur(5px)}
        .row{display:flex;justify-content:space-between;align-items:center;font-size:10px;font-family:monospace}
        .led{width:6px;height:6px;border-radius:50%;background:#333;transition:0.3s}
        .led.on{background:#0f0;box-shadow:0 0 8px #0f0} .led.wait{background:#ff0} .led.err{background:#f00}
        #g-track{width:100%;height:4px;background:#222;border-radius:2px;overflow:hidden;margin-top:5px}
        #g-fill{width:0%;height:100%;background:#0f0;transition:width 0.1s}

        /* 详情 */
        #info{position:absolute;bottom:140px;right:20px;width:220px;padding:15px;transition:0.4s;opacity:0;transform:translateY(20px)}
        #info.show{opacity:1;transform:translateY(0)}
        #info.collapsed{height:30px;padding:0 15px;width:auto;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center}
        #info.collapsed .content{display:none} 
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-family:monospace;font-size:10px;color:#aaa;margin-top:15px}
        .item span{display:block;color:#666;font-size:9px;margin-bottom:2px}
        #toggle{position:absolute;top:8px;right:8px;background:0;border:0;color:#fff;font-size:12px;cursor:pointer}

        /* 启动 */
        #cover{position:fixed;inset:0;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:0.5s}
        #start{margin-top:30px;background:0;border:1px solid #444;color:#fff;padding:12px 50px;letter-spacing:6px;font-size:12px;cursor:pointer;border-radius:4px;transition:0.2s}
        #start:hover{background:rgba(255,255,255,0.2)}
        #msg-log{color:#f44;font-size:10px;margin-top:10px;max-width:80%;text-align:center;display:none}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="cover">
        <div style="font-size:24px;letter-spacing:8px;color:#ddd">SOLAR XXI</div>
        <div style="font-size:10px;color:#666;margin-top:10px;letter-spacing:2px">ROBUST START</div>
        <button id="start">ENTER SYSTEM</button>
        <div id="msg-log"></div>
    </div>

    <div class="ui">
        <div class="panel" id="nav"></div>
        
        <div id="lang-box">
            <div id="l-slider"></div>
            <button class="l-btn active" d-l="CN">CN</button>
            <button class="l-btn" d-l="EN">EN</button>
            <button class="l-btn" d-l="DE">DE</button>
            <button class="l-btn" d-l="FR">FR</button>
            <button class="l-btn" d-l="ES">ES</button>
            <button class="l-btn" d-l="IT">IT</button>
        </div>

        <div id="hud">
            <div class="row">
                <span id="txt-sys">SYSTEM STATUS</span>
                <span id="pos-debug" style="color:#666">0, 0</span>
            </div>
            <div class="row">
                <div style="display:flex;align-items:center;gap:5px"><div class="led" id="led-c"></div><span id="t-cam">CAM</span></div>
                <div style="display:flex;align-items:center;gap:5px"><div class="led" id="led-h"></div><span id="t-hand">HAND</span></div>
            </div>
            <div class="row" style="margin-top:5px">
                <span id="t-mode">MODE:</span><span style="color:#fff;font-weight:700" id="val-act">--</span>
            </div>
            <div id="g-track"><div id="g-fill"></div></div>
        </div>

        <div class="panel" id="info">
            <button id="toggle" onclick="toggleInfo()">-</button>
            <div class="content">
                <h1 id="p-n" style="margin:0;font-weight:100;letter-spacing:2px;font-size:24px;color:#fff">EARTH</h1>
                <span id="p-d" style="font-size:10px;color:#888;text-transform:uppercase;display:block;margin-bottom:15px">Habitable</span>
                <div class="grid">
                    <div class="item"><span id="l-dia">DIA</span><div id="v-dia">0</div></div>
                    <div class="item"><span id="l-tmp">TMP</span><div id="v-tmp">0</div></div>
                    <div class="item"><span id="l-gra">GRAV</span><div id="v-gra">0</div></div>
                    <div class="item"><span id="l-day">ROT</span><div id="v-day">0</div></div>
                </div>
            </div>
        </div>
    </div>

    <video id="input-video" playsinline webkit-playsinline muted autoplay></video>
    <div id="canvas-container"></div>

    <script type="x-shader/x-vertex" id="vs">
        attribute float size; attribute vec3 mo; attribute float rs;
        uniform float time; uniform float disp; varying float vA;
        void main() {
            vec3 pos = position;
            vec3 dPos = pos + mo * (1.0 + sin(time*0.5 + rs)*0.2);
            dPos.x += sin(time*0.3 + rs*10.0)*3.0; dPos.y += cos(time*0.2 + rs*20.0)*3.0; dPos.z += sin(time*0.4 + rs*30.0)*3.0;
            vec3 fPos = mix(pos, dPos, disp);
            fPos *= 1.0 + sin(time*2.0 + rs*10.0)*(0.05*(1.0-disp));
            vec4 mv = modelViewMatrix * vec4(fPos, 1.0);
            gl_PointSize = size * (1.0 + disp * 2.5) * (200.0 / -mv.z);
            gl_Position = projectionMatrix * mv;
            vA = 0.9 - disp * 0.6;
        }
    </script>
    <script type="x-shader/x-fragment" id="fs">
        uniform sampler2D tex; uniform vec3 col; varying float vA;
        void main() {
            vec4 t = texture2D(tex, gl_PointCoord);
            if(t.a < 0.05) discard;
            gl_FragColor = vec4(col, vA * t.r); 
        }
    </script>

    <script>
        const LANG = {
            CN: {
                sys: "星系全览", sun: "太阳", mer: "水星", ven: "金星", ear: "地球", mar: "火星", jup: "木星", sat: "土星", ura: "天王星", nep: "海王星",
                desc: { sun: "主序星", mer: "岩石世界", ven: "浓厚大气", ear: "蓝色星球", mar: "红色沙漠", jup: "气体巨星", sat: "光环行星", ura: "冰巨星", nep: "蓝色冰球" },
                lbl: { dia: "直径", tmp: "温度", gra: "重力", day: "自转" },
                hud: { st: "系统状态", cam: "相机", hand: "手势", m_solid: "实体", m_mist: "星云" }
            },
            EN: {
                sys: "SYSTEM VIEW", sun: "SUN", mer: "MERCURY", ven: "VENUS", ear: "EARTH", mar: "MARS", jup: "JUPITER", sat: "SATURN", ura: "URANUS", nep: "NEPTUNE",
                desc: { sun: "Main Sequence", mer: "Rocky World", ven: "Thick Cloud", ear: "Blue Marble", mar: "Red Desert", jup: "Gas Giant", sat: "Ringed Jewel", ura: "Ice Giant", nep: "Deep Blue" },
                lbl: { dia: "DIAMETER", tmp: "TEMP", gra: "GRAVITY", day: "DAY" },
                hud: { st: "SYSTEM STATUS", cam: "CAM", hand: "HAND", m_solid: "SOLID", m_mist: "MIST" }
            },
            DE: {
                sys: "SYSTEM", sun: "SONNE", mer: "MERKUR", ven: "VENUS", ear: "ERDE", mar: "MARS", jup: "JUPITER", sat: "SATURN", ura: "URANUS", nep: "NEPTUN",
                desc: { sun: "Hauptreihe", mer: "Felsplanet", ven: "Dichte Wolken", ear: "Der Blaue Planet", mar: "Rote Wüste", jup: "Gasriese", sat: "Ringplanet", ura: "Eisriese", nep: "Blauer Riese" },
                lbl: { dia: "DURCHMESSER", tmp: "TEMP", gra: "GRAVITATION", day: "TAG" },
                hud: { st: "STATUS", cam: "KAMERA", hand: "HAND", m_solid: "FEST", m_mist: "NEBEL" }
            },
            FR: {
                sys: "SYSTÈME", sun: "SOLEIL", mer: "MERCURE", ven: "VÉNUS", ear: "TERRE", mar: "MARS", jup: "JUPITER", sat: "SATURNE", ura: "URANUS", nep: "NEPTUNE",
                desc: { sun: "Séquence Principale", mer: "Monde Rocheux", ven: "Nuages Épais", ear: "Planète Bleue", mar: "Désert Rouge", jup: "Géante Gazeuse", sat: "Planète à Anneaux", ura: "Géante de Glace", nep: "Monde Bleu" },
                lbl: { dia: "DIAMÈTRE", tmp: "TEMP", gra: "GRAVITÉ", day: "JOUR" },
                hud: { st: "ÉTAT", cam: "CAMÉRA", hand: "MAIN", m_solid: "SOLIDE", m_mist: "NÉBULEUSE" }
            },
            ES: {
                sys: "SISTEMA", sun: "SOL", mer: "MERCURIO", ven: "VENUS", ear: "TIERRA", mar: "MARTE", jup: "JÚPITER", sat: "SATURNO", ura: "URANO", nep: "NEPTUNO",
                desc: { sun: "Secuencia Principal", mer: "Mundo Rocoso", ven: "Nubes Espesas", ear: "Planeta Azul", mar: "Desierto Rojo", jup: "Gigante Gaseoso", sat: "Planeta Anillado", ura: "Gigante de Hielo", nep: "Mundo Azul" },
                lbl: { dia: "DIÁMETRO", tmp: "TEMP", gra: "GRAVEDAD", day: "DÍA" },
                hud: { st: "ESTADO", cam: "CÁMARA", hand: "MANO", m_solid: "SÓLIDO", m_mist: "NIEBLA" }
            },
            IT: {
                sys: "SISTEMA", sun: "SOLE", mer: "MERCURIO", ven: "VENERE", ear: "TERRA", mar: "MARTE", jup: "GIOVE", sat: "SATURNO", ura: "URANO", nep: "NETTUNO",
                desc: { sun: "Sequenza Principale", mer: "Mondo Roccioso", ven: "Nubi Dense", ear: "Pianeta Blu", mar: "Deserto Rosso", jup: "Gigante Gassoso", sat: "Pianeta Anellato", ura: "Gigante Ghiacciato", nep: "Mondo Blu" },
                lbl: { dia: "DIAMETRO", tmp: "TEMP", gra: "GRAVITÀ", day: "GIORNO" },
                hud: { st: "STATO", cam: "CAMERA", hand: "MANO", m_solid: "SOLIDO", m_mist: "NEBBIA" }
            }
        };

        const DB = [
            { id: "sys", r:0, d:0, s:0, c:[1,1,1] },
            { id: "sun", r:12, d:0, s:0, c:[1.0,0.85,0.6], dat:{dia:"1.39M km",t:"5500°C",g:"274",day:"25d"} },
            { id: "mer", r:2.2, d:25, s:0.8, c:[0.7,0.7,0.75], dat:{dia:"4879 km",t:"167°C",g:"3.7",day:"58d"} },
            { id: "ven", r:3.8, d:40, s:0.6, c:[0.85,0.8,0.65], dat:{dia:"12104 km",t:"464°C",g:"8.87",day:"243d"} },
            { id: "ear", r:4.0, d:60, s:0.5, c:[0.3,0.55,0.8], dat:{dia:"12742 km",t:"15°C",g:"9.8",day:"24h"} },
            { id: "mar", r:2.8, d:80, s:0.4, c:[0.8,0.4,0.3], dat:{dia:"6779 km",t:"-65°C",g:"3.71",day:"24.6h"} },
            { id: "jup", r:10, d:115, s:0.2, c:[0.75,0.7,0.6], dat:{dia:"139820 km",t:"-110°C",g:"24.79",day:"9.9h"} },
            { id: "sat", r:9, d:150, s:0.15, c:[0.8,0.75,0.65], ring:true, dat:{dia:"116460 km",t:"-140°C",g:"10.44",day:"10.5h"} },
            { id: "ura", r:7, d:185, s:0.1, c:[0.6,0.8,0.85], dat:{dia:"50724 km",t:"-195°C",g:"8.69",day:"17h"} },
            { id: "nep", r:7, d:220, s:0.08, c:[0.35,0.45,0.85], dat:{dia:"49244 km",t:"-200°C",g:"11.15",day:"16h"} }
        ];

        let curLang='CN', activeIdx=-1, state={disp:0, tDisp:0, hX:0, hY:0, tHX:0, tHY:0};
        let scene, cam, ren, ctr, uni, planets=[];

        // --- CORE LOGIC START ---
        document.getElementById('start').onclick = () => {
            const btn = document.getElementById('start');
            btn.innerText = "LOADING...";
            
            // 立即启动3D，不等待摄像头，防止卡死
            try {
                init3D();
                upLang();
                const b = document.querySelector('.l-btn[d-l="CN"]'); if(b) slide(b);
                document.getElementById('cover').style.opacity=0;
                setTimeout(()=>document.getElementById('cover').style.display='none',500);
                
                // 后台启动摄像头
                initVid().catch(err => {
                    console.log("Cam failed, but 3D runs:", err);
                    document.getElementById('led-c').className = "led err";
                });
            } catch(e) {
                alert("Critical Error: " + e.message);
            }
        };

        function toggleInfo() { document.getElementById('info').classList.toggle('collapsed'); }

        document.querySelectorAll('.l-btn').forEach(b => {
            b.onclick = (e) => {
                document.querySelectorAll('.l-btn').forEach(x=>x.classList.remove('active'));
                e.target.classList.add('active');
                curLang = e.target.getAttribute('d-l');
                slide(e.target); upLang();
            }
        });
        function slide(el) {
            const s = document.getElementById('l-slider');
            s.style.width = el.offsetWidth + 'px'; s.style.left = el.offsetLeft + 'px';
        }

        function upLang() {
            const t = LANG[curLang];
            DB.forEach((d,i) => { const b=document.getElementById(`n-${i}`); if(b) b.innerText = t[d.id]; });
            if(activeIdx!==-1) {
                const d = DB[activeIdx];
                document.getElementById('p-n').innerText = t[d.id].toUpperCase();
                document.getElementById('p-d').innerText = t.desc[d.id];
                document.getElementById('l-dia').innerText = t.lbl.dia;
                document.getElementById('l-tmp').innerText = t.lbl.tmp;
                document.getElementById('l-gra').innerText = t.lbl.gra;
                document.getElementById('l-day').innerText = t.lbl.day;
            }
            document.getElementById('txt-sys').innerText = t.hud.st;
            document.getElementById('t-cam').innerText = t.hud.cam;
            document.getElementById('t-hand').innerText = t.hud.hand;
            document.getElementById('t-mode').innerText = "MODE:";
            const act = document.getElementById('val-act');
            act.innerText = state.disp > 0.5 ? t.hud.m_mist : t.hud.m_solid;
        }

        function getTex() {
            const c=document.createElement('canvas'); c.width=64; c.height=64; const x=c.getContext('2d');
            const g=x.createRadialGradient(32,32,0,32,32,32); g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(0.4,'rgba(255,255,255,0.3)'); g.addColorStop(1,'rgba(0,0,0,0)');
            x.fillStyle=g; x.fillRect(0,0,64,64); return new THREE.CanvasTexture(c);
        }

        function init3D() {
            const con = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.001);
            cam = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
            cam.position.set(0, 100, 200);
            ren = new THREE.WebGLRenderer({antialias:true, alpha:false});
            ren.setSize(window.innerWidth, window.innerHeight); ren.setPixelRatio(Math.min(window.devicePixelRatio,2));
            con.appendChild(ren.domElement);
            ctr = new THREE.OrbitControls(cam, ren.domElement);
            ctr.enableDamping=true; ctr.enablePan=false; ctr.autoRotate=true; ctr.autoRotateSpeed=0.3; ctr.maxDistance=600;
            
            sGrp = new THREE.Group(); scene.add(sGrp);
            uni = { time: {value:0}, disp: {value:0}, tex: {value:getTex()} };
            
            // Stars
            const gS=new THREE.BufferGeometry(), pS=[];
            for(let i=0;i<3000;i++){ const r=600+Math.random()*600, th=Math.random()*6.28, ph=Math.acos(Math.random()*2-1); pS.push(r*Math.sin(ph)*Math.cos(th), r*Math.sin(ph)*Math.sin(th), r*Math.cos(ph)); }
            gS.setAttribute('position', new THREE.Float32BufferAttribute(pS,3));
            scene.add(new THREE.Points(gS, new THREE.PointsMaterial({color:0x444444, size:2, transparent:true, opacity:0.6})));

            const n = document.getElementById('nav');
            DB.forEach((d, i) => {
                const b = document.createElement('button'); b.className='btn'; b.id=`n-${i}`; b.innerText=LANG.CN[d.id];
                if(i===0) b.classList.add('active'); b.onclick=()=>focus(i); n.appendChild(b);
                if(i===0) return;
                const piv = new THREE.Group(); sGrp.add(piv);
                const mg = new THREE.Group(); piv.add(mg);
                addL(mg, d, d.r*0.7, d.id==="sun"?2000:800, 1.2, 1.0);
                addL(mg, d, d.r*1.0, d.id==="sun"?3000:1500, 1.5, 0.8);
                if(d.id!=="mer") addL(mg, d, d.r*1.3, 600, 2.5, 0.4);
                if(d.ring) addR(mg, d);
                mg.position.x = d.d;
                if(d.d>0) {
                    const pts=[]; for(let k=0;k<=128;k++){ const a=(k/128)*6.28; pts.push(new THREE.Vector3(Math.cos(a)*d.d,0,Math.sin(a)*d.d)); }
                    const lG=new THREE.BufferGeometry().setFromPoints(pts);
                    sGrp.add(new THREE.LineLoop(lG, new THREE.LineBasicMaterial({color:0xffffff, transparent:true, opacity:0.15, blending:THREE.AdditiveBlending})));
                }
                planets.push({piv, mg, s:d.s*0.003, d});
            });

            animate(sGrp);
            window.onresize = () => { cam.aspect=window.innerWidth/window.innerHeight; cam.updateProjectionMatrix(); ren.setSize(window.innerWidth, window.innerHeight); };
        }

        function addL(g, d, r, c, ss, as) {
            const geo=new THREE.BufferGeometry(), pos=[], mo=[], rs=[], sz=[];
            const col = new THREE.Color(d.c[0], d.c[1], d.c[2]); const hsl={}; col.getHSL(hsl);
            for(let k=0; k<c; k++) {
                const rad=r, th=Math.random()*6.28, ph=Math.acos(Math.random()*2-1);
                pos.push(rad*Math.sin(ph)*Math.cos(th), rad*Math.sin(ph)*Math.sin(th), rad*Math.cos(ph));
                const s=d.r*8; mo.push((Math.random()-0.5)*s, (Math.random()-0.5)*s, (Math.random()-0.5)*s);
                rs.push(Math.random()); sz.push((Math.random()*1.5+0.5)*ss);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3)); geo.setAttribute('mo', new THREE.Float32BufferAttribute(mo,3));
            geo.setAttribute('rs', new THREE.Float32BufferAttribute(rs,1)); geo.setAttribute('size', new THREE.Float32BufferAttribute(sz,1));
            g.add(new THREE.Points(geo, new THREE.ShaderMaterial({
                uniforms:{...uni, col:{value:col.clone().setHSL(hsl.h,hsl.s,hsl.l*as)}},
                vertexShader:document.getElementById('vs').textContent, fragmentShader:document.getElementById('fs').textContent,
                blending:THREE.AdditiveBlending, depthWrite:false, transparent:true
            })));
        }

        function addR(g, d) {
            const geo=new THREE.BufferGeometry(), pos=[], mo=[], rs=[], sz=[];
            for(let k=0; k<1200; k++) {
                const rad=d.r*(1.5+Math.random()*1.5), th=Math.random()*6.28;
                pos.push(rad*Math.cos(th), (Math.random()-0.5)*0.3, rad*Math.sin(th));
                mo.push((Math.random()-0.5)*d.r*6, (Math.random()-0.5)*d.r*6, (Math.random()-0.5)*d.r*6);
                rs.push(Math.random()); sz.push(Math.random()*1.2+0.5);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3)); geo.setAttribute('mo', new THREE.Float32BufferAttribute(mo,3));
            geo.setAttribute('rs', new THREE.Float32BufferAttribute(rs,1)); geo.setAttribute('size', new THREE.Float32BufferAttribute(sz,1));
            g.add(new THREE.Points(geo, new THREE.ShaderMaterial({
                uniforms:{...uni, col:{value:new THREE.Color(0.8,0.75,0.6)}},
                vertexShader:document.getElementById('vs').textContent, fragmentShader:document.getElementById('fs').textContent,
                blending:THREE.AdditiveBlending, depthWrite:false, transparent:true
            })));
        }

        function animate(grp) {
            requestAnimationFrame(()=>animate(grp));
            const t = performance.now()*0.001; uni.time.value = t; TWEEN.update();
            
            state.disp += (state.tDisp - state.disp) * 0.08; uni.disp.value = state.disp;
            state.hX += (state.tHX - state.hX) * 0.05; state.hY += (state.tHY - state.hY) * 0.05;
            
            if(grp) { grp.rotation.x = state.hY * 0.3; grp.rotation.y = state.hX * 0.3; }
            
            // HUD
            document.getElementById('g-fill').style.width = (state.disp*100)+'%';
            document.getElementById('pos-debug').innerText = `${state.hX.toFixed(2)}, ${state.hY.toFixed(2)}`;
            const lT = LANG[curLang];
            const act = document.getElementById('val-act');
            if(state.disp>0.5) { act.innerText=lT.hud.m_mist; act.style.color='#0f0'; document.getElementById('g-fill').style.background='#0f0'; }
            else { act.innerText=lT.hud.m_solid; act.style.color='#888'; document.getElementById('g-fill').style.background='#444'; }

            planets.forEach(p=>p.piv.rotation.y+=p.s);
            if(activeIdx>0) {
                const tg = planets[activeIdx-1]; if(tg){ const wp=new THREE.Vector3(); tg.mg.getWorldPosition(wp); ctr.target.copy(wp); }
            }
            ctr.update(); ren.render(scene, cam);
        }

        function focus(i) {
            activeIdx=i; document.querySelectorAll('.btn').forEach((b,k)=>b.classList.toggle('active',k===i));
            const inf=document.getElementById('info');
            if(i===0) {
                activeIdx=-1; inf.classList.remove('show'); ctr.autoRotate=true;
                new TWEEN.Tween(cam.position).to({x:0,y:100,z:200},1500).easing(TWEEN.Easing.Cubic.Out).start();
                new TWEEN.Tween(ctr.target).to({x:0,y:0,z:0},1500).start();
            } else {
                ctr.autoRotate=false; upLang();
                const d=DB[i];
                document.getElementById('v-dia').innerText=d.dat.dia; document.getElementById('v-tmp').innerText=d.dat.t;
                document.getElementById('v-gra').innerText=d.dat.g; document.getElementById('v-day').innerText=d.dat.day;
                inf.classList.add('show'); ctr.minDistance=d.r*2.5;
                const tg=planets[i-1]; const wp=new THREE.Vector3(); tg.mg.getWorldPosition(wp);
                const off=wp.clone().normalize().multiplyScalar(d.r*5+30); off.y+=15; const ce=wp.clone().add(off);
                new TWEEN.Tween(cam.position).to({x:ce.x,y:ce.y,z:ce.z},1500).easing(TWEEN.Easing.Cubic.Out).start();
            }
        }

        async function initVid() {
            const v = document.getElementById('input-video');
            const h = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            h.setOptions({maxNumHands:1, minDetectionConfidence:0.5});
            h.onResults(res => {
                const led=document.getElementById('led-h');
                if(res.multiHandLandmarks.length>0) {
                    led.className="led on";
                    const lm=res.multiHandLandmarks[0];
                    const w = Math.hypot(lm[8].x-lm[20].x, lm[8].y-lm[20].y);
                    const p = Math.hypot(lm[0].x-lm[9].x, lm[0].y-lm[9].y);
                    state.tDisp = w > p*1.3 ? 1.0 : 0.0;
                    
                    const cx=(lm[0].x+lm[9].x)/2; const cy=(lm[0].y+lm[9].y)/2;
                    state.tHX = (0.5-cx)*2; state.tHY = (0.5-cy)*2;
                } else {
                    led.className="led wait"; state.tDisp=0; state.tHX=0; state.tHY=0;
                }
            });
            const c = new Camera(v, {onFrame:async()=>{await h.send({image:v})}, width:320, height:240, facingMode:'user'});
            await c.start();
            document.getElementById('led-c').className="led on";
        }
    </script>
</body>
</html>
