<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ‰‹åŠ¿æ§åˆ¶ç²’å­å¤ªé˜³ç³» - æ”¹è‰¯ç‰ˆ</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        #ui-container {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(20,20,30,0.7); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.08);
            color: white; z-index: 10; transition: all 0.5s ease;
        }
        h2 { margin: 0 0 15px 0; font-size:1.2rem; font-weight:300; }
        .control-group { margin-bottom: 15px; }
        label { display:block; margin-bottom:5px; font-size:0.9rem; color:#aaa; }
        .planet-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; }
        .planet-btn { background: rgba(255,255,255,0.08); border:none; color:#fff; padding:8px 0; border-radius:6px; cursor:pointer; font-size:0.8rem; }
        .planet-btn:hover, .planet-btn.active { background: rgba(0,150,255,0.6); }
        input[type="color"] { width:100%; height:35px; border:none; background:none; cursor:pointer; }
        #status { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:rgba(255,255,255,0.6); font-size:0.9rem; background: rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; pointer-events:none; }
        #input_video { position:absolute; bottom:10px; right:10px; width:160px; height:120px; transform:scaleX(-1); border-radius:8px; opacity:0.5; z-index:5; }
        #fullscreen-btn, #toggle-ui-btn { position:absolute; top:20px; right:20px; background: rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.3); color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; }
        #toggle-ui-btn { right:70px; }
        #info-panel { position:absolute; top:20px; right:20px; width:300px; background: rgba(30,30,50,0.85); backdrop-filter: blur(8px); padding:15px; border-radius:10px; color:#fff; z-index:10; transition: all 0.5s ease; }
        #info-panel h3 { color:#f9d71c; border-bottom:1px solid #444; padding-bottom:5px; margin-top:0; }
        @media (max-width:600px) {
            #ui-container { width:calc(100% - 40px); top:auto; bottom:60px; }
            #input_video { display:none; }
            #info-panel { top:10px; left:10px; right:auto; width:calc(100% - 20px); }
            #fullscreen-btn { top:10px; right:10px; }
            #toggle-ui-btn { top:10px; right:60px; }
        }
    </style>
</head>
<body>
    <video id="input_video"></video>
    <div id="canvas-container"></div>

    <div id="ui-container">
        <h2>æ‰‹åŠ¿æ§åˆ¶ç²’å­å¤ªé˜³ç³»ï¼ˆæ”¹è‰¯ï¼‰</h2>
        <div class="control-group">
            <label>é€‰æ‹©å¤©ä½“ / èšç„¦</label>
            <div class="planet-grid" id="planet-selector"></div>
        </div>
        <div class="control-group" id="color-control-group">
            <label>æ˜Ÿäº‘é¢œè‰²</label>
            <input type="color" id="color-picker" value="#ffffff">
        </div>
        <div style="font-size:0.8rem;color:#666;line-height:1.4;">
            äº¤äº’è¯´æ˜:<br>
            ğŸ‘‹ <b>å·¦å³ç§»åŠ¨æ‰‹æŒ:</b> è°ƒæ•´è§†è§’ / æ—‹è½¬èšç„¦<br>
            ğŸ‘ <b>åŒæ‰‹å¼ å¼€/åˆæ‹¢:</b> æ‹‰è¿‘/æ‹‰è¿œç›¸æœºæˆ–è®©æ˜Ÿäº‘æ‰©æ•£
        </div>
    </div>

    <div id="info-panel">
        <h3>æ˜Ÿçƒç®€ä»‹ï¼š<span id="planet-name"></span></h3>
        <p>ğŸ”­ <b>ä¸€èˆ¬è§‚æµ‹æ˜Ÿç­‰ï¼š</b><span id="planet-magnitude"></span></p>
        <p>ğŸ‘ï¸ <b>å¦‚ä½•è‚‰çœ¼è§‚æµ‹ï¼š</b><span id="planet-obs"></span></p>
        <p>ğŸ’¡ <b>å¯¹ç”Ÿæ´»çš„å½±å“ï¼š</b><span id="planet-impact"></span></p>
        <p>ğŸ“œ <b>æœ‰è¶£çš„æ•…äº‹ï¼š</b><span id="planet-story"></span></p>
    </div>

    <div id="status">æ­£åœ¨åˆå§‹åŒ–æ‘„åƒå¤´ä¸AIæ¨¡å‹...</div>
    <button id="fullscreen-btn" onclick="toggleFullScreen()">â›¶</button>
    <button id="toggle-ui-btn" onclick="toggleUI()">âœ–</button>

<script>
/* ================= é…ç½®æ•°æ®ï¼ˆåŒä½ åŸå§‹æ•°æ®ï¼Œç¨ä½œè°ƒæ•´ï¼‰ */
const planets = [
    { name: 'Sun', color: '#FDB813', size: 1.6, distance: 0, speed: 0, magnitude: -26.74, obs: 'ç™½å¤©å¯è§ï¼ˆåˆ‡å‹¿ç›´è§†ï¼‰', impact: 'æä¾›èƒ½é‡ä¸å…‰ç…§', story: 'å¤ªé˜³ç¥é˜¿æ³¢ç½—çš„æˆ˜è½¦', focusDistance: 5 },
    { name: 'Mercury', color: '#A57C5B', size: 0.12, distance: 3.0, speed: 0.015, magnitude: -1.9, obs: 'é»æ˜æˆ–é»„æ˜ä½ç©ºå¯è§', impact: 'æœ€é è¿‘å¤ªé˜³', story: 'å¢¨ä¸˜åˆ©', focusDistance: 1.5 },
    { name: 'Venus', color: '#E3BB76', size: 0.2, distance: 4.5, speed: 0.012, magnitude: -4.9, obs: 'æäº®ï¼šæ™¨æ˜Ÿ/æ˜æ˜Ÿ', impact: 'æç«¯æ¸©å®¤æ•ˆåº”ç¤ºä¾‹', story: 'ç»´çº³æ–¯', focusDistance: 1.8 },
    { name: 'Earth', color: '#22A6F2', size: 0.22, distance: 6.0, speed: 0.01, magnitude: -3.99, obs: 'æˆ‘ä»¬çš„å®¶å›­', impact: 'ç”Ÿå‘½ä¹‹æº', story: 'å¤äººæ›¾ä»¥åœ°å¿ƒè¯´', focusDistance: 1.8 },
    { name: 'Mars', color: '#DF4925', size: 0.15, distance: 8.5, speed: 0.008, magnitude: -2.91, obs: 'çº¢è‰²æ˜¾çœ¼', impact: 'æœªæ¥æ®–æ°‘ç„¦ç‚¹', story: 'ç›å°”æ–¯', focusDistance: 1.6 },
    { name: 'Jupiter', color: '#C88B3A', size: 0.6, distance: 15.0, speed: 0.005, magnitude: -2.94, obs: 'éå¸¸æ˜äº®', impact: 'å¼•åŠ›æŠ¤ç›¾', story: 'æœ±åº‡ç‰¹', focusDistance: 3.0 },
    { name: 'Saturn', color: '#C5AB6E', size: 0.5, distance: 20.0, speed: 0.004, magnitude: 0.47, obs: 'éœ€è¦æœ›è¿œé•œçœ‹å…‰ç¯', impact: 'å£®è§‚å…‰ç¯', story: 'è¨å›¾å°”åŠªæ–¯', focusDistance: 2.5 },
    { name: 'Uranus', color: '#4FD0E7', size: 0.4, distance: 25.0, speed: 0.003, magnitude: 5.9, obs: 'è¿‘æé™è‚‰çœ¼å¯è§', impact: 'ä¾§å§æ—‹è½¬è½´', story: 'ä¹Œæ‹‰è¯ºæ–¯', focusDistance: 2.2 },
    { name: 'Neptune', color: '#3E54E8', size: 0.4, distance: 30.0, speed: 0.002, magnitude: 7.8, obs: 'éœ€æœ›è¿œé•œ', impact: 'é£é€Ÿæé«˜', story: 'å°¼æ™®é¡¿', focusDistance: 2.2 }
];

/* ================= Three.js åˆå§‹åŒ– ================= */
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x000000, 0.005);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 10, 20);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('canvas-container').appendChild(renderer.domElement);

/* èƒŒæ™¯æ˜Ÿæ˜Ÿï¼ˆä¸å˜ï¼‰ */
function addStars() {
    const starGeo = new THREE.BufferGeometry();
    const starPos = [];
    for (let i=0;i<2500;i++){
        starPos.push((Math.random()-0.5)*600, (Math.random()-0.5)*600, (Math.random()-0.5)*600);
    }
    starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos,3));
    const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.12, transparent:true, opacity:0.7 });
    const stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);
}
addStars();

/* ====== çŠ¶æ€ä¸å‚æ•° ====== */
let currentMode = 'overview';
let currentFocusPlanet = planets[0];
let particleColor = planets[0].color;
let particleSystem = null;
let particleData = [];
const MAIN_PARTICLE_COUNT = 38000; // å¯æ ¹æ®æœºæ€§èƒ½è°ƒèŠ‚

// ç›¸æœºå¹³æ»‘æ§åˆ¶
let targetCameraPos = new THREE.Vector3(0,10,20);
let targetCameraLookAt = new THREE.Vector3(0,0,0);

/* ====== ç”Ÿæˆè½¯åœ†ç²’å­çº¹ç†ï¼ˆcanvasï¼‰ ====== */
function makeSprite(size=128) {
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = size;
    const ctx = canvas.getContext('2d');

    const grad = ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
    grad.addColorStop(0.0, 'rgba(255,255,255,1.0)');
    grad.addColorStop(0.3, 'rgba(255,255,255,0.85)');
    grad.addColorStop(0.6, 'rgba(200,200,200,0.4)');
    grad.addColorStop(1.0, 'rgba(0,0,0,0.0)');

    ctx.fillStyle = grad;
    ctx.fillRect(0,0,size,size);

    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.LinearFilter;
    texture.magFilter = THREE.LinearFilter;
    texture.needsUpdate = true;
    return texture;
}
const particleSprite = makeSprite(128);

/* ====== ç€è‰²å™¨ï¼ˆæ”¯æŒ per-vertex size & color & textureï¼‰ ====== */
const vertexShader = `
    attribute float size;
    attribute vec3 customColor;
    varying vec3 vColor;
    void main() {
        vColor = customColor;
        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
        // æ·±åº¦è¡°å‡ï¼Œç”¨äºè§†è§‰ä¸Šåœ¨è¿œå¤„ç²’å­æ›´å°
        gl_PointSize = size * ( 200.0 / -mvPosition.z );
        gl_Position = projectionMatrix * mvPosition;
    }
`;
const fragmentShader = `
    uniform sampler2D pointTexture;
    varying vec3 vColor;
    void main() {
        vec4 tex = texture2D(pointTexture, gl_PointCoord);
        // å°†é¡¶ç‚¹é¢œè‰²ä¹˜ä»¥çº¹ç†å€¼ï¼Œä»è€Œè·å¾—æŸ”å’Œè¾¹ç¼˜ä¸è‰²å½©
        vec3 col = vColor;
        gl_FragColor = vec4(col * tex.rgb, tex.a);
        if (gl_FragColor.a < 0.02) discard;
    }
`;

/* ====== é‡‡æ ·å‡½æ•°ï¼šåœ¨çƒä½“å†…å‡åŒ€é‡‡æ ·ï¼ˆä½“ç§¯åˆ†å¸ƒï¼‰ ====== */
function randomPointInSphere(radius) {
    // å‡åŒ€å¡«å……çƒä½“ä½“ç§¯ï¼šæ–¹å‘å‡åŒ€ï¼ŒåŠå¾„ r ~ cbrt(u)*R
    const u = Math.random();
    const costheta = Math.random()*2 - 1;
    const phi = Math.random() * Math.PI * 2;
    const r = Math.cbrt(u) * radius;
    const sintheta = Math.sqrt(1 - costheta*costheta);
    const x = r * sintheta * Math.cos(phi);
    const y = r * sintheta * Math.sin(phi);
    const z = r * costheta;
    return new THREE.Vector3(x,y,z);
}

/* ====== åˆ›å»ºç²’å­ç³»ç»Ÿï¼šä¸»ä½“ï¼ˆbodyï¼‰ä¸æ˜Ÿäº‘ï¼ˆcloudï¼‰éƒ½ä¸ºä½“ç§¯åˆ†å¸ƒ ====== */
function createSolarSystemParticles() {
    // æ¸…ç†æ—§çš„
    if (particleSystem) { scene.remove(particleSystem); particleSystem.geometry.dispose(); particleSystem.material.dispose(); }
    particleData = [];

    // ä¸´æ—¶æ•°ç»„ï¼Œéšåå†™å…¥ Buffer
    const temp = [];

    planets.forEach(p => {
        const coreColor = new THREE.Color(p.color);
        const cloudBase = coreColor.clone().multiplyScalar(0.75);

        // ä¸»ä½“ç²’å­æ•°æŒ‰è¡Œæ˜Ÿå¤§å°æ¯”ä¾‹å¢åŠ 
        const bodyCount = (p.name === 'Sun') ? 4000 : Math.max(600, Math.round(1200 * p.size));
        for (let i=0;i<bodyCount;i++){
            // ç¨å¾®å‘å¿ƒï¼šä¸»ä½“æ›´å¯†é›†ï¼Œä½¿ç”¨ radius = size * (0.6)
            const v = randomPointInSphere(p.size * 0.6);
            // jitter color slightly
            const col = coreColor.clone().multiplyScalar(0.9 + Math.random()*0.2);
            temp.push({
                pos: new THREE.Vector3().copy(v).add(new THREE.Vector3(p.distance,0,0)),
                originalPos: v.clone(), // ç”¨äºè‡ªè½¬
                id: p.name,
                type: 'body',
                color: col,
                orbitDistance: p.distance,
                speed: p.speed,
                angle: Math.random()*Math.PI*2,
                size: (p.name==='Sun') ? 6.0 : 2.0  // æ³¨æ„ï¼šè¿™é‡Œæ˜¯åŸºå‡† sizeï¼Œä¼šè¢« shader æ·±åº¦è¡°å‡æ§åˆ¶
            });
        }

        // æ˜Ÿäº‘/ç¯ç»•ï¼šèŒƒå›´æ›´å¤§ã€æ›´ç¨€ç–
        const cloudCount = (p.name === 'Sun') ? 8000 : Math.max(1500, Math.round(3000 * p.size));
        for (let i=0;i<cloudCount;i++){
            const radius = p.size * (1.0 + Math.random()*2.0); // æ›´å¤§çš„å¤–æ‰©
            // é‡‡æ ·æ—¶å°½é‡è®©äº‘æœ‰å±‚æ¬¡æ„Ÿï¼šéšæœºç”Ÿæˆæ–¹å‘ & radius^(1/2) ä¿æŒå¤–å±‚æ›´å¤šç‚¹
            const v = randomPointInSphere(radius);
            const c = cloudBase.clone().multiplyScalar(0.6 + Math.random()*0.6);
            temp.push({
                pos: new THREE.Vector3().copy(v).add(new THREE.Vector3(p.distance,0,0)),
                originalPos: v.clone(),
                id: p.name,
                type: 'cloud',
                color: c,
                orbitDistance: p.distance,
                speed: p.speed * (0.9 + Math.random()*0.4),
                angle: Math.random()*Math.PI*2,
                size: 0.6 + Math.random()*1.2
            });
        }
    });

    // è£å‰ªæˆ–å¡«å……åˆ° MAIN_PARTICLE_COUNT
    const total = Math.min(temp.length, MAIN_PARTICLE_COUNT);
    particleData = temp.slice(0, total);

    // å»ºç«‹ BufferGeometry
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(MAIN_PARTICLE_COUNT * 3);
    const colors = new Float32Array(MAIN_PARTICLE_COUNT * 3);
    const sizes = new Float32Array(MAIN_PARTICLE_COUNT);

    // å†™å…¥å®é™…ç²’å­
    for (let i=0;i<total;i++){
        const p = particleData[i];
        positions[i*3] = p.pos.x;
        positions[i*3+1] = p.pos.y;
        positions[i*3+2] = p.pos.z;

        colors[i*3] = p.color.r;
        colors[i*3+1] = p.color.g;
        colors[i*3+2] = p.color.b;

        sizes[i] = p.size;
    }
    // å¡«å……å‰©ä½™
    for (let i=total;i<MAIN_PARTICLE_COUNT;i++){
        positions[i*3]=positions[i*3+1]=positions[i*3+2]=0;
        colors[i*3]=colors[i*3+1]=colors[i*3+2]=0;
        sizes[i]=0;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions,3));
    geometry.setAttribute('customColor', new THREE.BufferAttribute(colors,3));
    geometry.setAttribute('size', new THREE.BufferAttribute(sizes,1));

    // ShaderMaterial
    const material = new THREE.ShaderMaterial({
        uniforms: {
            pointTexture: { value: particleSprite }
        },
        vertexShader,
        fragmentShader,
        transparent: true,
        depthWrite: false,
        blending: THREE.AdditiveBlending,
        vertexColors: true
    });

    particleSystem = new THREE.Points(geometry, material);
    scene.add(particleSystem);

    // é»˜è®¤æ›´æ–° info panel
    updatePlanetInfo(currentFocusPlanet);
}

/* ====== UI æ„å»ºï¼ˆä¿ç•™ä½ åŸå§‹é€»è¾‘ï¼‰ ====== */
const planetSelector = document.getElementById('planet-selector');
const overviewBtn = document.createElement('button');
overviewBtn.className = 'planet-btn active';
overviewBtn.innerText = 'æ€»è§ˆå¤ªé˜³ç³»';
overviewBtn.onclick = () => {
    document.querySelectorAll('.planet-btn').forEach(b=>b.classList.remove('active'));
    overviewBtn.classList.add('active');
    currentMode = 'overview';
    currentFocusPlanet = planets[0];
    document.getElementById('color-control-group').style.visibility = 'hidden';
    targetCameraPos.set(0,10,20);
    updatePlanetInfo(currentFocusPlanet);
};
planetSelector.appendChild(overviewBtn);
planets.filter(p=>p.name!=='Sun').forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'planet-btn';
    btn.innerText = p.name;
    btn.onclick = () => {
        document.querySelectorAll('.planet-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = 'focus';
        currentFocusPlanet = p;
        particleColor = p.color;
        document.getElementById('color-control-group').style.visibility = 'visible';
        document.getElementById('color-picker').value = p.color;
        updatePlanetInfo(p);
    };
    planetSelector.appendChild(btn);
});
document.getElementById('color-control-group').style.visibility = 'hidden';
document.getElementById('color-picker').addEventListener('input', e=>{
    particleColor = e.target.value;
});

/* ====== æ›´æ–° info panel ====== */
function updatePlanetInfo(pd){
    document.getElementById('planet-name').textContent = pd.name;
    document.getElementById('planet-magnitude').textContent = pd.magnitude ? `${pd.magnitude} M` : 'N/A';
    document.getElementById('planet-obs').textContent = pd.obs;
    document.getElementById('planet-impact').textContent = pd.impact;
    document.getElementById('planet-story').textContent = pd.story;
}

/* ====== åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ ====== */
createSolarSystemParticles();

/* ====== MediaPipe æ‰‹åŠ¿æ§åˆ¶ï¼ˆä¿ç•™å¹¶ç¨ä½œè°ƒæ•´ï¼‰ ====== */
const videoElement = document.getElementById('input_video');
const statusElement = document.getElementById('status');

let targetX = 0, currentX = 0;
let targetScale = 20, currentScale = 20;

const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
hands.onResults(onResults);

const cameraUtils = new Camera(videoElement, {
    onFrame: async () => { await hands.send({ image: videoElement }); },
    width: 640, height: 480
});
cameraUtils.start().catch(err=>{ statusElement.innerText = "æ‘„åƒå¤´è®¿é—®å¤±è´¥"; console.error(err); });

function onResults(results){
    statusElement.innerText = "ç³»ç»Ÿè¿è¡Œä¸­ - è¯·ç§»åŠ¨åŒæ‰‹";
    statusElement.style.color = "#4FD0E7";

    if (!particleSystem) return;

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks;
        let avgX = 0;
        landmarks.forEach(h => avgX += h[9].x);
        avgX /= landmarks.length;
        const screenX = (1 - avgX) * 2 - 1;
        targetX = screenX * 1;

        if (landmarks.length === 2) {
            const h1 = landmarks[0][0], h2 = landmarks[1][0];
            const dist = Math.sqrt((h1.x-h2.x)**2 + (h1.y-h2.y)**2);
            if (currentMode === 'focus') {
                // æ§åˆ¶æ˜Ÿäº‘æ‰©æ•£ï¼ˆä¸æ”¾å¤ªå¤§ï¼‰
                targetScale = 0.8 + (dist * 2.0);
                targetScale = Math.min(Math.max(targetScale, 0.6), 2.2);
            } else {
                // æ€»è§ˆæ¨¡å¼ï¼šæ§åˆ¶ç›¸æœº Z
                const minZ = 12, maxZ = 40;
                const adjusted = Math.max(0, Math.min(1, 1 - dist));
                targetScale = minZ + adjusted * (maxZ - minZ);
            }
        } else {
            targetScale = (currentMode === 'focus') ? 1.0 : 20.0;
        }
    } else {
        targetX = 0;
        targetScale = (currentMode === 'focus') ? 1.0 : 20.0;
        statusElement.innerText = "æœªæ£€æµ‹åˆ°æ‰‹éƒ¨";
        statusElement.style.color = "#aaa";
    }
}

/* ====== æ¸²æŸ“å¾ªç¯ ====== */
function animate() {
    requestAnimationFrame(animate);
    if (!particleSystem) return;

    const positions = particleSystem.geometry.attributes.position.array;
    const colors = particleSystem.geometry.attributes.customColor.array;
    const sizes = particleSystem.geometry.attributes.size.array;

    // å¹³æ»‘å‚æ•°
    currentScale += (targetScale - currentScale) * 0.12;
    currentX += (targetX - currentX) * 0.08;

    // æ±‚ä¸­å¿ƒä½ç½®ï¼ˆä¸»ä½“ç²’å­å¹³å‡ï¼‰ç”¨äºèšç„¦è®¡ç®—
    let focusX = 0, focusY = 0, focusZ = 0;
    let focusBodyCount = 0;

    // æ›´æ–°æ¯ä¸ªç²’å­çš„ä½ç½®ï¼ˆå…¬è½¬ + è‡ªè½¬ + èšç„¦ç¼©æ”¾ï¼‰
    for (let i=0;i<particleData.length;i++){
        const p = particleData[i];

        // å…¬è½¬ï¼šè®©è¡Œæ˜Ÿç»•åŸç‚¹è½¬
        if (p.orbitDistance > 0) {
            p.angle += p.speed * 0.8; // æ”¾æ…¢ä¸€ç‚¹ä»¥ä¾¿è§‚æ„Ÿæ›´æŸ”å’Œ
            const orbitX = p.orbitDistance * Math.cos(p.angle);
            const orbitZ = p.orbitDistance * Math.sin(p.angle);
            // è‡ªè½¬ï¼šåŸºäº originalPos æ—‹è½¬ï¼ˆæ›´æŸ”å’Œï¼‰
            const rot = Date.now() * 0.0001 * (p.id === 'Sun' ? 0.3 : 1.0);
            const ox = p.originalPos.x * Math.cos(rot) - p.originalPos.z * Math.sin(rot);
            const oz = p.originalPos.x * Math.sin(rot) + p.originalPos.z * Math.cos(rot);

            // èšç„¦æ—¶ï¼šåªæœ‰å½“å‰èšç„¦è¡Œæ˜Ÿçš„ç²’å­æ”¾å¤§å°‘é‡
            const isFocused = p.id === currentFocusPlanet.name;
            const focusMul = (isFocused && currentMode === 'focus') ? (1.0 + (currentScale - 1.0) * 0.3) : 1.0;

            positions[i*3] = orbitX + ox * focusMul;
            positions[i*3+1] = p.originalPos.y * focusMul;
            positions[i*3+2] = orbitZ + oz * focusMul;

            // èšç„¦æ—¶è®°å½•ä¸»ä½“ä½ç½®å¹³å‡ï¼ˆç”¨äºç›¸æœºï¼‰
            if (isFocused && p.type === 'body') {
                focusX += positions[i*3];
                focusY += positions[i*3+1];
                focusZ += positions[i*3+2];
                focusBodyCount++;
            }

            // äº‘é¢œè‰²åœ¨èšç„¦æ—¶å¾®è°ƒä¸ºç”¨æˆ·é€‰æ‹©é¢œè‰²ï¼ˆä½†ä¸ä¼šçªå…€ï¼‰
            if (currentMode === 'focus' && isFocused && p.type === 'cloud') {
                const tc = new THREE.Color(particleColor);
                // åªéƒ¨åˆ†æ··åˆåˆ°é¡¶ç‚¹é¢œè‰²ï¼ˆä¸ä¼šç¬é—´æ›¿æ¢ï¼‰
                const idx = i*3;
                colors[idx] = THREE.MathUtils.lerp(colors[idx], tc.r * 0.8, 0.06);
                colors[idx+1] = THREE.MathUtils.lerp(colors[idx+1], tc.g * 0.8, 0.06);
                colors[idx+2] = THREE.MathUtils.lerp(colors[idx+2], tc.b * 0.8, 0.06);
            }

            // å¤§å°ï¼šä¸»ä½“ç•¥å¤§ï¼Œäº‘è¾ƒå°ã€‚èšç„¦æ—¶æ”¾å¤§å¹…åº¦æ§åˆ¶åœ¨è¾ƒå°èŒƒå›´ã€‚
            sizes[i] = p.size * (p.type === 'body' ? 1.1 : 0.9) * (currentMode === 'focus' && p.id === currentFocusPlanet.name ? 1.05 : 1.0);
        } else {
            // å¤ªé˜³ä¸­å¿ƒä¿æŒ
            const rot = Date.now() * 0.00008;
            const ox = p.originalPos.x * Math.cos(rot) - p.originalPos.z * Math.sin(rot);
            const oz = p.originalPos.x * Math.sin(rot) + p.originalPos.z * Math.cos(rot);
            positions[i*3] = ox;
            positions[i*3+1] = p.originalPos.y;
            positions[i*3+2] = oz;
        }
    }

    // æ›´æ–° geometry æ ‡å¿—
    particleSystem.geometry.attributes.position.needsUpdate = true;
    particleSystem.geometry.attributes.customColor.needsUpdate = true;
    particleSystem.geometry.attributes.size.needsUpdate = true;

    // ç›¸æœºå¹³æ»‘æ§åˆ¶
    if (focusBodyCount > 0 && currentMode === 'focus') {
        focusX /= focusBodyCount; focusY /= focusBodyCount; focusZ /= focusBodyCount;
        targetCameraLookAt.set(focusX, focusY, focusZ);
        const orbitRadius = currentFocusPlanet.focusDistance * 1.4;
        const camAngle = currentX * 0.6;
        targetCameraPos.set(
            focusX + orbitRadius * Math.sin(camAngle),
            focusY + 0.7,
            focusZ + orbitRadius * Math.cos(camAngle)
        );
    } else {
        // æ€»è§ˆæ¨¡å¼ï¼šè®©æ‰‹åŠ¿æ§åˆ¶ç»• Y è½´æ—‹è½¬å¹¶æ§åˆ¶ Z è·ç¦»
        targetCameraLookAt.set(0,0,0);
        scene.rotation.y = currentX * 0.4;
        targetCameraPos.set(0, 10, targetScale);
    }

    camera.position.lerp(targetCameraPos, 0.08);
    camera.lookAt(targetCameraLookAt);

    renderer.render(scene, camera);
}
animate();

/* ====== çª—å£ä¸ UI æ§åˆ¶ ====== */
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

let isUIHidden = false;
function toggleUI() {
    const uiPanel = document.getElementById('ui-container');
    const infoPanel = document.getElementById('info-panel');
    const toggleBtn = document.getElementById('toggle-ui-btn');
    if (isUIHidden) {
        uiPanel.style.transform = 'translateX(0)'; infoPanel.style.transform = 'translateX(0)'; toggleBtn.innerText='âœ–';
    } else {
        uiPanel.style.transform = 'translateX(-350px)'; infoPanel.style.transform = 'translateX(350px)'; toggleBtn.innerText='â˜°';
    }
    isUIHidden = !isUIHidden;
}
function toggleFullScreen(){
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
}

/* ====== å°æç¤ºï¼šå¦‚æœéœ€è¦é‡æ–°ç”Ÿæˆç²’å­ï¼ˆä¾‹å¦‚è°ƒ MAIN_PARTICLE_COUNTï¼‰ï¼Œè°ƒç”¨ createSolarSystemParticles() ====== */

</script>
</body>
</html>
