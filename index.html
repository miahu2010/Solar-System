<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Solar Dust XX - Omni-Lingual</title>
    <style>
        :root { --bg: #000; --panel: rgba(20,20,20,0.6); --border: rgba(255,255,255,0.15); --accent: #fff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); overflow: hidden; font-family: "Segoe UI", sans-serif; -webkit-user-select: none; user-select: none; }
        
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        #input-video { position: fixed; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1; }

        /* UI */
        .ui { position: absolute; z-index: 10; width: 100%; height: 100%; pointer-events: none; color: #ccc; }
        .panel { pointer-events: auto; background: var(--panel); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 6px; transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); }

        /* 1. 导航 (折叠) */
        #nav { position: absolute; top: 20px; left: 20px; width: 140px; max-height: 50vh; overflow: hidden; display: flex; flex-direction: column; }
        #nav.collapsed { width: 36px; height: 36px; background: rgba(0,0,0,0.8); }
        #nav.collapsed #nav-content { opacity: 0; pointer-events: none; }
        #nav.collapsed #nav-toggle { transform: rotate(180deg); }
        #nav-content { padding: 5px; overflow-y: auto; transition: opacity 0.3s; margin-top: 25px; height: 100%; }
        #nav-toggle { position: absolute; top: 8px; left: 8px; width: 20px; height: 20px; background: none; border: none; color: #fff; cursor: pointer; transition: 0.3s; z-index: 5; }
        .btn { display: block; width: 100%; background: none; border: none; color: #888; text-align: left; padding: 10px 8px; cursor: pointer; font-size: 12px; transition: 0.2s; border-radius: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .btn:hover { color: #fff; background: rgba(255,255,255,0.05); } .btn.active { color: #fff; font-weight: bold; background: rgba(255,255,255,0.1); border-left: 3px solid #fff; }

        /* 2. 语言 */
        #lang-container { position: absolute; top: 20px; right: 20px; pointer-events: auto; display: flex; align-items: center; background: var(--panel); padding: 4px; border-radius: 20px; border: 1px solid var(--border); }
        .lang-btn { background: none; border: none; color: #888; font-size: 10px; cursor: pointer; padding: 6px 10px; border-radius: 16px; position: relative; z-index: 2; transition: 0.3s; }
        .lang-btn.active { color: #000; font-weight: bold; }
        #lang-slider { position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); background: #fff; border-radius: 16px; z-index: 1; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); width: 0; }

        /* 3. 仪表盘 */
        #hud-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 280px; background: rgba(0,0,0,0.8); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 6px; backdrop-filter: blur(5px); pointer-events: none; }
        .hud-row { display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-family: monospace; }
        .status-box { display: flex; gap: 15px; } .indicator { display: flex; align-items: center; gap: 6px; }
        .led { width: 6px; height: 6px; border-radius: 50%; background: #333; transition: 0.3s; } .led.on { background: #0f0; box-shadow: 0 0 8px #0f0; } .led.wait { background: #ff0; }
        #gesture-track { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 5px; }
        #gesture-fill { width: 0%; height: 100%; background: #0f0; transition: width 0.1s; }

        /* 4. 详情 (折叠) */
        #info-card { position: absolute; bottom: 140px; right: 20px; width: 220px; padding: 15px; opacity: 0; transform: translateY(20px); height: auto; overflow: hidden; }
        #info-card.show { opacity: 1; transform: translateY(0); }
        #info-card.collapsed { height: 30px; padding: 0 15px; width: 80px; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; }
        #info-card.collapsed .info-content { opacity: 0; pointer-events: none; } #info-card.collapsed #info-toggle { transform: rotate(180deg); }
        .info-content { transition: opacity 0.3s; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-family: monospace; font-size: 10px; color: #aaa; margin-top: 15px; }
        .data-item span { display: block; color: #666; font-size: 9px; margin-bottom: 2px; }
        #info-toggle { position: absolute; top: 10px; right: 10px; width: 20px; height: 20px; background: none; border: none; color: #fff; cursor: pointer; font-size: 12px; transition: 0.3s; z-index: 5; }
        #info-toggle-text { display: none; font-size: 10px; letter-spacing: 1px; color: #fff; }
        #info-card.collapsed #info-toggle-text { display: block; } #info-card.collapsed #info-toggle { top: 6px; right: 5px; }

        /* 启动 */
        #cover { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.8s; }
        #btn-start { margin-top: 30px; background: transparent; border: 1px solid #444; color: #fff; padding: 12px 50px; letter-spacing: 6px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: 0.3s; }
        #btn-start:hover { border-color: #fff; background: rgba(255,255,255,0.1); }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="cover">
        <div style="font-size:24px;letter-spacing:8px;color:#ddd;text-align:center">SOLAR XX</div>
        <div style="font-size:10px;color:#666;margin-top:10px;letter-spacing:2px">OMNI-LINGUAL</div>
        <button id="btn-start">INITIALIZE</button>
    </div>

    <div class="ui">
        <div class="panel" id="nav">
            <button id="nav-toggle" onclick="toggleNav()">◀</button>
            <div id="nav-content"></div>
        </div>
        
        <div id="lang-container">
            <div id="lang-slider"></div>
            <button class="lang-btn active" d-l="CN">CN</button>
            <button class="lang-btn" d-l="EN">EN</button>
            <button class="lang-btn" d-l="DE">DE</button>
            <button class="lang-btn" d-l="FR">FR</button>
            <button class="lang-btn" d-l="ES">ES</button>
            <button class="lang-btn" d-l="IT">IT</button>
        </div>

        <button onclick="window.location.href='page2.html'" style="position:absolute;top:70px;right:20px;pointer-events:auto;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:10px;padding:6px 12px;border-radius:15px;cursor:pointer">LINK ➔</button>

        <div id="hud-container">
            <div class="hud-row" style="border-bottom:1px solid #333;padding-bottom:5px;margin-bottom:5px">
                <span id="txt-sys" style="color:#666">SYSTEM STATUS</span><span id="pos-debug" style="color:#666">0, 0</span>
            </div>
            <div class="status-box">
                <div class="indicator"><div class="led" id="led-cam"></div><span id="txt-cam">CAM</span></div>
                <div class="indicator"><div class="led" id="led-hand"></div><span id="txt-hand">HAND</span></div>
            </div>
            <div class="hud-row" style="margin-top:8px">
                <span class="hud-label">MODE:</span><span class="hud-val" id="val-action">--</span>
            </div>
            <div id="gesture-track"><div id="gesture-fill"></div></div>
        </div>

        <div class="panel" id="info-card">
            <button id="info-toggle" onclick="toggleInfo()">▼</button>
            <span id="info-toggle-text">INFO</span>
            <div class="info-content">
                <h1 id="p-name" style="margin:0;font-weight:100;letter-spacing:2px;font-size:24px;color:#fff">EARTH</h1>
                <span id="p-desc" style="font-size:10px;color:#888;text-transform:uppercase;display:block;margin-bottom:15px">Habitable Zone</span>
                <div class="data-grid">
                    <div class="data-item"><span id="l-dia">DIA</span><div id="d-dia">0</div></div>
                    <div class="data-item"><span id="l-tmp">TMP</span><div id="d-tmp">0</div></div>
                    <div class="data-item"><span id="l-gra">GRAV</span><div id="d-grav">0</div></div>
                    <div class="data-item"><span id="l-day">ROT</span><div id="d-day">0</div></div>
                </div>
            </div>
        </div>
    </div>

    <video id="input-video" playsinline webkit-playsinline muted autoplay></video>
    <div id="canvas-container"></div>

    <script type="x-shader/x-vertex" id="vShader">
        attribute float size; attribute vec3 mistOffset; attribute float randomScale;
        uniform float uTime; uniform float uDisperse; varying float vAlpha;
        void main() {
            vec3 sPos = position;
            vec3 mPos = sPos + mistOffset * (1.0 + sin(uTime*0.5 + randomScale)*0.2);
            mPos.x += sin(uTime*0.3 + randomScale*10.0)*3.0; mPos.y += cos(uTime*0.2 + randomScale*20.0)*3.0; mPos.z += sin(uTime*0.4 + randomScale*30.0)*3.0;
            vec3 fPos = mix(sPos, mPos, uDisperse);
            fPos *= 1.0 + sin(uTime*2.0 + randomScale*10.0)*(0.05*(1.0-uDisperse));
            vec4 mv = modelViewMatrix * vec4(fPos, 1.0);
            gl_PointSize = size * (1.0 + uDisperse * 2.5) * (200.0 / -mv.z);
            gl_Position = projectionMatrix * mv;
            vAlpha = 0.9 - uDisperse * 0.6;
        }
    </script>
    <script type="x-shader/x-fragment" id="fShader">
        uniform sampler2D uTexture; uniform vec3 uColor; varying float vAlpha;
        void main() {
            vec4 t = texture2D(uTexture, gl_PointCoord);
            if(t.a < 0.05) discard;
            gl_FragColor = vec4(uColor, vAlpha * t.r); 
        }
    </script>

    <script>
        // --- 完整多语言字典 ---
        const LANG = {
            CN: {
                lbl: { dia:"直径", tmp:"温度", gra:"重力", day:"自转" }, sys: "星系全览", sun: "太阳", mer: "水星", ven: "金星", ear: "地球", mar: "火星", jup: "木星", sat: "土星", ura: "天王星", nep: "海王星",
                desc: { sun: "主序星", mer: "岩石世界", ven: "浓厚大气", ear: "蓝色星球", mar: "红色沙漠", jup: "气体巨星", sat: "光环行星", ura: "冰巨星", nep: "蓝色冰球" },
                hud: { st: "系统状态", cam: "相机", hand: "手势", m_solid: "实体", m_mist: "星云" }
            },
            EN: {
                lbl: { dia:"DIAMETER", tmp:"TEMP", gra:"GRAVITY", day:"ROTATION" }, sys: "SYSTEM VIEW", sun: "SUN", mer: "MERCURY", ven: "VENUS", ear: "EARTH", mar: "MARS", jup: "JUPITER", sat: "SATURN", ura: "URANUS", nep: "NEPTUNE",
                desc: { sun: "Main Sequence", mer: "Rocky World", ven: "Thick Cloud", ear: "Blue Marble", mar: "Red Desert", jup: "Gas Giant", sat: "Ringed Jewel", ura: "Ice Giant", nep: "Deep Blue" },
                hud: { st: "SYSTEM STATUS", cam: "CAM", hand: "HAND", m_solid: "SOLID", m_mist: "MIST" }
            },
            DE: {
                lbl: { dia:"DURCHMESSER", tmp:"TEMP", gra:"GRAVITATION", day:"ROTATION" }, sys: "SYSTEM", sun: "SONNE", mer: "MERKUR", ven: "VENUS", ear: "ERDE", mar: "MARS", jup: "JUPITER", sat: "SATURN", ura: "URANUS", nep: "NEPTUN",
                desc: { sun: "Hauptreihe", mer: "Felsplanet", ven: "Dichte Wolken", ear: "Der Blaue Planet", mar: "Rote Wüste", jup: "Gasriese", sat: "Ringplanet", ura: "Eisriese", nep: "Blauer Riese" },
                hud: { st: "STATUS", cam: "KAMERA", hand: "HAND", m_solid: "FEST", m_mist: "NEBEL" }
            },
            FR: {
                lbl: { dia:"DIAMÈTRE", tmp:"TEMP", gra:"GRAVITÉ", day:"ROTATION" }, sys: "SYSTÈME", sun: "SOLEIL", mer: "MERCURE", ven: "VÉNUS", ear: "TERRE", mar: "MARS", jup: "JUPITER", sat: "SATURNE", ura: "URANUS", nep: "NEPTUNE",
                desc: { sun: "Séquence Principale", mer: "Monde Rocheux", ven: "Nuages Épais", ear: "Planète Bleue", mar: "Désert Rouge", jup: "Géante Gazeuse", sat: "Planète à Anneaux", ura: "Géante de Glace", nep: "Monde Bleu" },
                hud: { st: "ÉTAT", cam: "CAMÉRA", hand: "MAIN", m_solid: "SOLIDE", m_mist: "NÉBULEUSE" }
            },
            ES: {
                lbl: { dia:"DIÁMETRO", tmp:"TEMP", gra:"GRAVEDAD", day:"ROTACIÓN" }, sys: "SISTEMA", sun: "SOL", mer: "MERCURIO", ven: "VENUS", ear: "TIERRA", mar: "MARTE", jup: "JÚPITER", sat: "SATURNO", ura: "URANO", nep: "NEPTUNO",
                desc: { sun: "Secuencia Principal", mer: "Mundo Rocoso", ven: "Nubes Espesas", ear: "Planeta Azul", mar: "Desierto Rojo", jup: "Gigante Gaseoso", sat: "Planeta Anillado", ura: "Gigante de Hielo", nep: "Mundo Azul" },
                hud: { st: "ESTADO", cam: "CÁMARA", hand: "MANO", m_solid: "SÓLIDO", m_mist: "NIEBLA" }
            },
            IT: {
                lbl: { dia:"DIAMETRO", tmp:"TEMP", gra:"GRAVITÀ", day:"ROTAZIONE" }, sys: "SISTEMA", sun: "SOLE", mer: "MERCURIO", ven: "VENERE", ear: "TERRA", mar: "MARTE", jup: "GIOVE", sat: "SATURNO", ura: "URANO", nep: "NETTUNO",
                desc: { sun: "Sequenza Principale", mer: "Mondo Roccioso", ven: "Nubi Dense", ear: "Pianeta Blu", mar: "Deserto Rosso", jup: "Gigante Gassoso", sat: "Pianeta Anellato", ura: "Gigante Ghiacciato", nep: "Mondo Blu" },
                hud: { st: "STATO", cam: "CAMERA", hand: "MANO", m_solid: "SOLIDO", m_mist: "NEBBIA" }
            }
        };

        const DB = [
            { id: "sys", r:0, d:0, s:0, c:[1,1,1] },
            { id: "sun", r:12, d:0, s:0, c:[1.0,0.85,0.6], dat:{dia:"1.39M km",t:"5500°C",g:"274",day:"25d"} },
            { id: "mer", r:2.2, d:25, s:0.8, c:[0.7,0.7,0.75], dat:{dia:"4879 km",t:"167°C",g:"3.7",day:"58d"} },
            { id: "ven", r:3.8, d:40, s:0.6, c:[0.85,0.8,0.65], dat:{dia:"12104 km",t:"464°C",g:"8.87",day:"243d"} },
            { id: "ear", r:4.0, d:60, s:0.5, c:[0.3,0.55,0.8], dat:{dia:"12742 km",t:"15°C",g:"9.8",day:"24h"} },
            { id: "mar", r:2.8, d:80, s:0.4, c:[0.8,0.4,0.3], dat:{dia:"6779 km",t:"-65°C",g:"3.71",day:"24.6h"} },
            { id: "jup", r:10, d:115, s:0.2, c:[0.75,0.7,0.6], dat:{dia:"139820 km",t:"-110°C",g:"24.79",day:"9.9h"} },
            { id: "sat", r:9, d:150, s:0.15, c:[0.8,0.75,0.65], ring:true, dat:{dia:"116460 km",t:"-140°C",g:"10.44",day:"10.5h"} },
            { id: "ura", r:7, d:185, s:0.1, c:[0.6,0.8,0.85], dat:{dia:"50724 km",t:"-195°C",g:"8.69",day:"17h"} },
            { id: "nep", r:7, d:220, s:0.08, c:[0.35,0.45,0.85], dat:{dia:"49244 km",t:"-200°C",g:"11.15",day:"16h"} }
        ];

        let curLang='CN', activeIdx=-1, state={disp:0, tDisp:0, hX:0, hY:0, tHX:0, tHY:0};
        let scene, cam, ren, ctr, uni, planets=[], sGrp;

        document.getElementById('start').onclick = () => {
            document.getElementById('start').innerText = "CONNECTING...";
            initVid().then(() => {
                document.getElementById('cover').style.opacity=0;
                setTimeout(()=>document.getElementById('cover').style.display='none',800);
                init3D(); upLang();
                const b = document.querySelector('.l-btn[d-l="CN"]'); if(b) slide(b);
            });
        };

        function toggleInfo() { document.getElementById('info').classList.toggle('collapsed'); }
        function toggleNav() { document.getElementById('nav').classList.toggle('collapsed'); }

        document.querySelectorAll('.l-btn').forEach(b => {
            b.onclick = (e) => {
                document.querySelectorAll('.l-btn').forEach(x=>x.classList.remove('active'));
                e.target.classList.add('active');
                curLang = e.target.getAttribute('d-l');
                slide(e.target); upLang();
            }
        });
        function slide(el) {
            const s = document.getElementById('l-slider');
            s.style.width = el.offsetWidth + 'px'; s.style.left = el.offsetLeft + 'px';
        }

        function upLang() {
            const t = LANG[curLang];
            DB.forEach((d,i) => { const b=document.getElementById(`n-${i}`); if(b) b.innerText = t[d.id] || d.name; });
            if(activeIdx!==-1) {
                const d = DB[activeIdx];
                document.getElementById('p-n').innerText = (t[d.id] || d.name).toUpperCase();
                document.getElementById('p-d').innerText = t.desc[d.id];
                document.getElementById('l-dia').innerText = t.lbl.dia;
                document.getElementById('l-tmp').innerText = t.lbl.tmp;
                document.getElementById('l-gra').innerText = t.lbl.gra;
                document.getElementById('l-day').innerText = t.lbl.day;
            }
            document.getElementById('txt-sys').innerText = t.hud.st;
            document.getElementById('t-cam').innerText = t.hud.cam;
            document.getElementById('t-hand').innerText = t.hud.hand;
            const act = document.getElementById('val-act');
            act.innerText = state.disp > 0.5 ? t.hud.m_mist : t.hud.m_solid;
        }

        function getTex() {
            const c=document.createElement('canvas'); c.width=64; c.height=64; const x=c.getContext('2d');
            const g=x.createRadialGradient(32,32,0,32,32,32); g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(0.4,'rgba(255,255,255,0.3)'); g.addColorStop(1,'rgba(0,0,0,0)');
            x.fillStyle=g; x.fillRect(0,0,64,64); return new THREE.CanvasTexture(c);
        }

        function init3D() {
            const con = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x000000, 0.001);
            cam = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
            cam.position.set(0, 100, 200);
            ren = new THREE.WebGLRenderer({antialias:true, alpha:false});
            ren.setSize(window.innerWidth, window.innerHeight); ren.setPixelRatio(Math.min(window.devicePixelRatio,2));
            con.appendChild(ren.domElement);
            ctr = new THREE.OrbitControls(cam, ren.domElement);
            ctr.enableDamping=true; ctr.enablePan=false; ctr.autoRotate=true; ctr.autoRotateSpeed=0.3; ctr.maxDistance=600;
            
            sGrp = new THREE.Group(); scene.add(sGrp);
            uni = { time: {value:0}, disp: {value:0}, tex: {value:getTex()} };
            
            // Stars
            const gS=new THREE.BufferGeometry(), pS=[];
            for(let i=0;i<3000;i++){ const r=600+Math.random()*600, th=Math.random()*6.28, ph=Math.acos(Math.random()*2-1); pS.push(r*Math.sin(ph)*Math.cos(th), r*Math.sin(ph)*Math.sin(th), r*Math.cos(ph)); }
            gS.setAttribute('position', new THREE.Float32BufferAttribute(pS,3));
            sGrp.add(new THREE.Points(gS, new THREE.PointsMaterial({color:0x444444, size:2, transparent:true, opacity:0.6})));

            const n = document.getElementById('nav-content');
            DB.forEach((d, i) => {
                const b = document.createElement('button'); b.className='btn'; b.id=`n-${i}`; b.innerText=LANG.CN[d.id];
                if(i===0) b.classList.add('active'); b.onclick=()=>focus(i); n.appendChild(b);
                
                if(i===0) return;
                const piv = new THREE.Group(); sGrp.add(piv);
                const mg = new THREE.Group(); piv.add(mg);
                
                addL(mg, d, d.r*0.7, d.id==="sun"?2000:800, 1.2, 1.0);
                addL(mg, d, d.r*1.0, d.id==="sun"?3000:1500, 1.5, 0.8);
                if(d.id!=="mer") addL(mg, d, d.r*1.3, 600, 2.5, 0.4);
                if(d.ring) addR(mg, d);
                
                mg.position.x = d.d;
                if(d.d>0) {
                    const pts=[]; for(let k=0;k<=128;k++){ const a=(k/128)*6.28; pts.push(new THREE.Vector3(Math.cos(a)*d.d,0,Math.sin(a)*d.d)); }
                    const lG=new THREE.BufferGeometry().setFromPoints(pts);
                    sGrp.add(new THREE.LineLoop(lG, new THREE.LineBasicMaterial({color:0xffffff, transparent:true, opacity:0.15, blending:THREE.AdditiveBlending})));
                }
                planets.push({piv, mg, s:d.s*0.003, d});
            });

            animate();
            window.onresize = () => { cam.aspect=window.innerWidth/window.innerHeight; cam.updateProjectionMatrix(); ren.setSize(window.innerWidth, window.innerHeight); };
        }

        function addL(g, d, r, c, ss, as) {
            const geo=new THREE.BufferGeometry(), pos=[], mo=[], rs=[], sz=[];
            const col = new THREE.Color(d.c[0], d.c[1], d.c[2]); const hsl={}; col.getHSL(hsl);
            for(let k=0; k<c; k++) {
                const rad=r, th=Math.random()*6.28, ph=Math.acos(Math.random()*2-1);
                pos.push(rad*Math.sin(ph)*Math.cos(th), rad*Math.sin(ph)*Math.sin(th), rad*Math.cos(ph));
                const s=d.r*8; mo.push((Math.random()-0.5)*s, (Math.random()-0.5)*s, (Math.random()-0.5)*s);
                rs.push(Math.random()); sz.push((Math.random()*1.5+0.5)*ss);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3)); geo.setAttribute('mo', new THREE.Float32BufferAttribute(mo,3));
            geo.setAttribute('rs', new THREE.Float32BufferAttribute(rs,1)); geo.setAttribute('size', new THREE.Float32BufferAttribute(sz,1));
            g.add(new THREE.Points(geo, new THREE.ShaderMaterial({
                uniforms:{...uni, col:{value:col.clone().setHSL(hsl.h,hsl.s,hsl.l*as)}},
                vertexShader:document.getElementById('vs').textContent, fragmentShader:document.getElementById('fs').textContent,
                blending:THREE.AdditiveBlending, depthWrite:false, transparent:true
            })));
        }

        function addR(g, d) {
            const geo=new THREE.BufferGeometry(), pos=[], mo=[], rs=[], sz=[];
            for(let k=0; k<1200; k++) {
                const rad=d.r*(1.5+Math.random()*1.5), th=Math.random()*6.28;
                pos.push(rad*Math.cos(th), (Math.random()-0.5)*0.3, rad*Math.sin(th));
                mo.push((Math.random()-0.5)*d.r*6, (Math.random()-0.5)*d.r*6, (Math.random()-0.5)*d.r*6);
                rs.push(Math.random()); sz.push(Math.random()*1.2+0.5);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3)); geo.setAttribute('mo', new THREE.Float32BufferAttribute(mo,3));
            geo.setAttribute('rs', new THREE.Float32BufferAttribute(rs,1)); geo.setAttribute('size', new THREE.Float32BufferAttribute(sz,1));
            g.add(new THREE.Points(geo, new THREE.ShaderMaterial({
                uniforms:{...uni, col:{value:new THREE.Color(0.8,0.75,0.6)}},
                vertexShader:document.getElementById('vs').textContent, fragmentShader:document.getElementById('fs').textContent,
                blending:THREE.AdditiveBlending, depthWrite:false, transparent:true
            })));
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now()*0.001; uni.time.value = t; TWEEN.update();
            
            state.disp += (state.tDisp - state.disp) * 0.08; uni.disp.value = state.disp;
            state.hX += (state.tHX - state.hX) * 0.05; state.hY += (state.tHY - state.hY) * 0.05;
            
            // Gravity Rotation
            if(sGrp) { sGrp.rotation.x = state.hY * 0.3; sGrp.rotation.y = state.hX * 0.3; }
            
            // HUD
            document.getElementById('g-fill').style.width = (state.disp*100)+'%';
            document.getElementById('pos-debug').innerText = `${state.hX.toFixed(2)}, ${state.hY.toFixed(2)}`;
            const lT = LANG[curLang];
            const act = document.getElementById('val-act');
            if(state.disp>0.5) { act.innerText=lT.hud.m_mist; act.style.color='#0f0'; document.getElementById('g-fill').style.background='#0f0'; }
            else { act.innerText=lT.hud.m_solid; act.style.color='#888'; document.getElementById('g-fill').style.background='#444'; }

            planets.forEach(p=>p.piv.rotation.y+=p.s);
            if(activeIdx>0) {
                const tg = planets[activeIdx-1]; if(tg){ const wp=new THREE.Vector3(); tg.mg.getWorldPosition(wp); ctr.target.copy(wp); }
            }
            ctr.update(); ren.render(scene, cam);
        }

        function focus(i) {
            activeIdx=i; document.querySelectorAll('.btn').forEach((b,k)=>b.classList.toggle('active',k===i));
            const inf=document.getElementById('info');
            info.classList.remove('collapsed');
            if(i===0) {
                activeIdx=-1; inf.classList.remove('show'); ctr.autoRotate=true;
                new TWEEN.Tween(cam.position).to({x:0,y:100,z:200},1500).easing(TWEEN.Easing.Cubic.Out).start();
                new TWEEN.Tween(ctr.target).to({x:0,y:0,z:0},1500).start();
            } else {
                ctr.autoRotate=false; upLang();
                const d=DB[i];
                document.getElementById('v-dia').innerText=d.dat.dia; document.getElementById('v-tmp').innerText=d.dat.t;
                document.getElementById('v-gra').innerText=d.dat.g; document.getElementById('v-day').innerText=d.dat.day;
                inf.classList.add('show'); ctr.minDistance=d.r*2.5;
                const tg=planets[i-1]; const wp=new THREE.Vector3(); tg.mg.getWorldPosition(wp);
                const off=wp.clone().normalize().multiplyScalar(d.r*5+30); off.y+=15; const ce=wp.clone().add(off);
                new TWEEN.Tween(cam.position).to({x:ce.x,y:ce.y,z:ce.z},1500).easing(TWEEN.Easing.Cubic.Out).start();
            }
        }

        async function initVid() {
            const v = document.getElementById('input-video');
            const h = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            h.setOptions({maxNumHands:1, minDetectionConfidence:0.5, modelComplexity:0});
            h.onResults(res => {
                const led=document.getElementById('led-h');
                if(res.multiHandLandmarks.length>0) {
                    led.className="led on";
                    const lm=res.multiHandLandmarks[0];
                    const w = Math.hypot(lm[8].x-lm[20].x, lm[8].y-lm[20].y);
                    const p = Math.hypot(lm[0].x-lm[9].x, lm[0].y-lm[9].y);
                    state.tDisp = w > p*1.3 ? 1.0 : 0.0;
                    
                    const cx=(lm[0].x+lm[9].x)/2; const cy=(lm[0].y+lm[9].y)/2;
                    state.tHX = (0.5-cx)*2; state.tHY = (0.5-cy)*2;
                } else {
                    led.className="led wait"; state.tDisp=0; state.tHX=0; state.tHY=0;
                }
            });
            const c = new Camera(v, {onFrame:async()=>{await h.send({image:v})}, width:320, height:240, facingMode:'user'});
            await c.start();
            document.getElementById('led-c').className="led on";
        }
    </script>
</body>
</html>
