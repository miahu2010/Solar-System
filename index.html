<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Solar Dust III - Nebula Edition</title>
    <style>
        :root {
            --bg-color: #020203; /* æ›´æ·±é‚ƒçš„å®‡å®™é»‘ */
            --glass-bg: rgba(20, 25, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #8ab4f8;
            --text-main: #e8eaed;
            --text-sub: #9aa0a6;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: "Segoe UI", Roboto, Helvetica, sans-serif;
            color: var(--text-main);
        }

        #canvas-container { width: 100%; height: 100%; position: absolute; z-index: 1; }
        #input-video { display: none; }

        /* UI Panels */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        h2 { font-size: 12px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-sub); margin: 0 0 10px 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; }
        
        #left-sidebar {
            position: absolute; top: 20px; left: 20px; width: 240px; z-index: 10;
            display: flex; flex-direction: column; gap: 15px;
        }

        .planet-list { display: flex; flex-direction: column; gap: 4px; max-height: 40vh; overflow-y: auto; }
        .planet-btn {
            padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text-sub);
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .planet-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .planet-btn.active { background: rgba(138, 180, 248, 0.15); color: var(--accent); }
        
        .guide-item { font-size: 11px; color: var(--text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .icon-box { width: 16px; height: 16px; background: rgba(255,255,255,0.1); border-radius: 4px; display: grid; place-items: center; font-size: 10px; }

        /* Info Panel */
        #info-panel {
            position: absolute; top: 20px; right: 20px; width: 280px; z-index: 10;
            transform: translateX(120%); opacity: 0;
        }
        #info-panel.visible { transform: translateX(0); opacity: 1; }
        .planet-title { font-size: 22px; font-weight: 300; letter-spacing: 2px; color: #fff; margin: 0; }
        .planet-subtitle { font-size: 11px; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; }
        .info-content { font-size: 12px; line-height: 1.5; color: rgba(255,255,255,0.8); margin-bottom: 15px; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .data-item { background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 6px; }
        .data-label { font-size: 9px; color: var(--text-sub); display: block; }
        .data-value { font-size: 11px; color: #fff; font-family: monospace; }
        #toggle-info { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-sub); cursor: pointer; }

        /* Status & Overlay */
        #cam-status {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10;
            display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-radius: 20px;
        }
        .status-dot { width: 6px; height: 6px; background: #444; border-radius: 50%; transition: 0.3s; }
        .status-dot.active { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-text { font-size: 12px; color: var(--text-sub); }

        #overlay {
            position: fixed; inset: 0; background: #020203; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s;
        }
        #start-btn {
            background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3);
            padding: 15px 40px; font-size: 14px; letter-spacing: 4px; text-transform: uppercase;
            cursor: pointer; transition: all 0.3s;
        }
        #start-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="overlay">
        <h1 style="font-weight: 100; font-size: 32px; letter-spacing: 8px; margin-bottom: 30px; text-align: center;">SOLAR <span style="color:#8ab4f8">NEBULA</span></h1>
        <button id="start-btn">Enter System</button>
    </div>

    <div id="left-sidebar">
        <div class="glass-panel" style="padding: 15px;">
            <h2>Navigation</h2>
            <div class="planet-list" id="planet-menu">
                <div class="planet-btn active" onclick="focusPlanet(-1)"><span>Overview</span><span>â—</span></div>
            </div>
        </div>
        <div class="glass-panel" style="padding: 15px;">
            <h2>Controls</h2>
            <div class="guide-item"><div class="icon-box">ğŸ–±ï¸</div> <span>é¼ æ ‡/è§¦æ§: æ—‹è½¬å’Œç¼©æ”¾è§†è§’</span></div>
            <div class="guide-item"><div class="icon-box">ğŸ‘</div> <span>å¼ å¼€æ‰‹æŒ: ç²’å­ç»½æ”¾ (è‡ªç”±æµ®åŠ¨)</span></div>
            <div class="guide-item"><div class="icon-box">âœŠ</div> <span>æ¡æ‹³: ç²’å­èšåˆ (æ ¸å¿ƒèšç„¦)</span></div>
        </div>
    </div>

    <div id="info-panel" class="glass-panel" style="padding: 20px;">
        <button id="toggle-info" onclick="toggleInfoPanel()">âœ•</button>
        <h1 class="planet-title" id="info-name">Earth</h1>
        <div class="planet-subtitle" id="info-type">Terrestrial Planet</div>
        <p class="info-content" id="info-desc">Description text here.</p>
        <div class="data-grid">
            <div class="data-item"><span class="data-label">DIAMETER</span><span class="data-value" id="info-dia">-</span></div>
            <div class="data-item"><span class="data-label">TEMP</span><span class="data-value" id="info-temp">-</span></div>
        </div>
    </div>

    <div id="cam-status" class="glass-panel">
        <div class="status-dot" id="status-dot"></div>
        <span class="status-text" id="status-text">Waiting for camera...</span>
    </div>

    <video id="input-video"></video>
    <div id="canvas-container"></div>

    <script type="x-shader/x-vertex" id="vertexShader">
        attribute float size;
        attribute vec3 originalPos; // è®°å½•ç²’å­çš„åˆå§‹çƒä½“ä½ç½®
        attribute float variation;

        uniform float uTime;
        uniform float uFist; // 0.0 (å¼ å¼€) åˆ° 1.0 (æ¡æ‹³)

        varying vec3 vColor;
        varying float vAlpha;

        // ç®€å•çš„ä¼ªéšæœºå‡½æ•°
        float random(vec3 st) {
            return fract(sin(dot(st.xyz, vec3(12.9898,78.233,45.164))) * 43758.5453123);
        }

        void main() {
            vColor = color;
            vec3 pos = originalPos;

            // --- 1. è‡ªç”±æµ®åŠ¨æ•ˆæœ (é’ˆå¯¹éœ€æ±‚ 1) ---
            // åŸºäºæ—¶é—´å’Œä½ç½®çš„æ­£å¼¦æ³¢å åŠ ï¼Œåˆ›é€ ç¼“æ…¢çš„æ¹æµæ„Ÿ
            float t = uTime * 0.3;
            vec3 noise = vec3(0.0);
            noise.x = sin(pos.y * 0.5 + t + variation) * cos(pos.z * 0.5 + t * 0.8);
            noise.y = cos(pos.x * 0.5 + t * 1.1 + variation) * sin(pos.z * 0.5 + t * 0.5);
            noise.z = sin(pos.x * 0.5 + t * 0.7 + variation) * cos(pos.y * 0.5 + t * 0.9);
            
            // ç»½æ”¾çŠ¶æ€ä¸‹ï¼Œæ¹æµå¹…åº¦æ›´å¤§
            float bloomFactor = 1.0 - uFist; 
            pos += noise * (1.5 + bloomFactor * 2.0);

            // --- 2. èšåˆ/ç»½æ”¾æ•ˆæœ (é’ˆå¯¹éœ€æ±‚ 4) ---
            // è®¡ç®—ç›®æ ‡ä½ç½®ï¼šå‘åœ°å¿ƒ (0,0,0) æ”¶ç¼©
            // uFist è¶Šå¤§ï¼Œè¶Šé è¿‘ä¸­å¿ƒã€‚ä¿ç•™ä¸€ç‚¹ç‚¹è·ç¦»é¿å…å®Œå…¨åç¼©æˆä¸€ä¸ªç‚¹ã€‚
            vec3 contractedPos = normalize(pos) * (length(originalPos) * 0.1); 
            
            // åœ¨åŸå§‹æµ®åŠ¨ä½ç½®å’Œæ”¶ç¼©ä½ç½®ä¹‹é—´æ’å€¼
            // ä½¿ç”¨å¹³æ»‘çš„æ’å€¼æ›²çº¿ pow(uFist, 2.0) è®©æ”¶ç¼©æ„Ÿæ›´å¼º
            pos = mix(pos, contractedPos, pow(uFist, 1.5) * 0.95);

            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);

            // å°ºå¯¸è®¡ç®—ï¼šæ¡æ‹³æ—¶ç²’å­ç¨å¾®å˜å¤§å˜äº®
            float currentSize = size * (1.0 + uFist * 0.5);
            gl_PointSize = currentSize * (180.0 / -mvPosition.z);
            gl_Position = projectionMatrix * mvPosition;

            // è¾¹ç¼˜é€æ˜åº¦è¡°å‡
            vAlpha = smoothstep(600.0, 10.0, -mvPosition.z);
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        uniform sampler2D pointTexture;
        uniform float uFist;
        varying vec3 vColor;
        varying float vAlpha;
        
        void main() {
            vec4 texColor = texture2D(pointTexture, gl_PointCoord);
            if(texColor.a < 0.1) discard;

            // æ¡æ‹³æ—¶ï¼Œæ ¸å¿ƒæ›´äº®ï¼Œè¾¹ç¼˜æ›´é”åˆ©
            float brightness = 1.0 + uFist * 1.5;
            float alpha = vAlpha * texColor.a;
            
            // ç»½æ”¾æ—¶æ›´æŸ”å’Œï¼Œèšåˆæ—¶æ›´é”åˆ©
            alpha = smoothstep(0.0 + uFist*0.2, 1.0, alpha);

            gl_FragColor = vec4(vColor * brightness, alpha);
        }
    </script>

    <script>
        // --- DATA ---
        const PLANETS_DB = [
            { name: "Sun", type: "Star", color: [1.0, 0.7, 0.3], radius: 14, distance: 0, speed: 0, desc: "The heart of our system. A near-perfect sphere of hot plasma.", data: { dia: "1.4M km", temp: "5,500Â°C" } },
            { name: "Mercury", type: "Terrestrial", color: [0.7, 0.7, 0.75], radius: 1.8, distance: 30, speed: 0.02, desc: "The smallest planet, closest to the Sun. A cratered, rocky body.", data: { dia: "4,879 km", temp: "167Â°C" } },
            { name: "Venus", type: "Terrestrial", color: [0.9, 0.8, 0.5], radius: 3.2, distance: 45, speed: 0.015, desc: "Wrapped in thick, toxic clouds of sulfuric acid trapping heat.", data: { dia: "12,104 km", temp: "464Â°C" } },
            { name: "Earth", type: "Terrestrial", color: [0.2, 0.6, 1.0], radius: 3.5, distance: 65, speed: 0.012, desc: "Our home world, the only place known to harbor life.", data: { dia: "12,742 km", temp: "15Â°C" } },
            { name: "Mars", type: "Terrestrial", color: [0.9, 0.3, 0.2], radius: 2.5, distance: 85, speed: 0.01, desc: "The Red Planet, a dusty, cold desert world.", data: { dia: "6,779 km", temp: "-65Â°C" } },
            { name: "Jupiter", type: "Gas Giant", color: [0.8, 0.7, 0.6], radius: 9, distance: 120, speed: 0.006, desc: "The largest planet, a massive ball of gas and liquid metal.", data: { dia: "139,820 km", temp: "-110Â°C" } },
            { name: "Saturn", type: "Gas Giant", color: [0.85, 0.8, 0.55], radius: 8, distance: 155, speed: 0.005, hasRings: true, desc: "Famous for its dazzling, complex system of icy rings.", data: { dia: "116,460 km", temp: "-140Â°C" } },
            { name: "Uranus", type: "Ice Giant", color: [0.5, 0.8, 0.9], radius: 5, distance: 190, speed: 0.004, desc: "An ice giant rotating on its side.", data: { dia: "50,724 km", temp: "-195Â°C" } },
            { name: "Neptune", type: "Ice Giant", color: [0.3, 0.4, 0.8], radius: 5, distance: 220, speed: 0.003, desc: "Dark, cold, and whipped by supersonic winds.", data: { dia: "49,244 km", temp: "-200Â°C" } }
        ];

        // --- GLOBAL VARS ---
        let scene, camera, renderer, controls;
        let uniforms;
        let solarSystemGroup, orbitSystemGroup;
        let planetMeshes = [];
        let focusedPlanetIdx = -1;
        let globalSpeed = 1.0;

        // Camera & Interaction State
        let targetCamPos = new THREE.Vector3(0, 70, 220);
        let currentCamPos = new THREE.Vector3(0, 70, 220);
        let targetLookAt = new THREE.Vector3(0, 0, 0);
        let currentLookAt = new THREE.Vector3(0, 0, 0);
        let handFistValue = 0.0; // 0.0 - 1.0 å¹³æ»‘è¿‡æ¸¡å€¼

        // --- INIT ---
        document.getElementById('start-btn').addEventListener('click', async function() {
            this.innerText = "Initializing...";
            await startCamera();
            init3D();
            createUI();
            animate();
            document.getElementById('overlay').style.opacity = 0;
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 800);
        });

        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            // ä½¿ç”¨æ›´é€šé€çš„é›¾ï¼Œå¢åŠ æ™¯æ·±æ„Ÿ
            scene.fog = new THREE.FogExp2(0x020203, 0.001);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.copy(currentCamPos);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            // ä½¿ç”¨åŠ æ³•æ··åˆçš„é¢„ä¹˜ Alpha è®¾ç½®ï¼Œè®©ç²’å­æ›´äº®
            renderer.setClearColor(0x020203, 1);
            container.appendChild(renderer.domElement);

            // --- éœ€æ±‚ 2: æ·»åŠ  OrbitControls ---
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // å¯ç”¨é˜»å°¼ï¼ˆæƒ¯æ€§ï¼‰ï¼Œè®©æ“ä½œæ›´ä¸æ»‘
            controls.dampingFactor = 0.05;
            controls.enablePan = false; // ç¦æ­¢å¹³ç§»ï¼Œåªå…è®¸æ—‹è½¬å’Œç¼©æ”¾
            controls.minDistance = 20;
            controls.maxDistance = 500;
            controls.autoRotate = true; // åˆå§‹è‡ªåŠ¨æ—‹è½¬
            controls.autoRotateSpeed = 0.5;

            solarSystemGroup = new THREE.Group();
            orbitSystemGroup = new THREE.Group();
            scene.add(solarSystemGroup);
            scene.add(orbitSystemGroup);

            uniforms = {
                uTime: { value: 0 },
                uFist: { value: 0.0 },
                pointTexture: { value: createSoftTexture() }
            };

            PLANETS_DB.forEach((data, index) => {
                const planetObj = createPlanet(data, uniforms);
                planetObj.userData = { angle: Math.random() * Math.PI * 2, distance: data.distance, speed: data.speed };
                planetObj.position.set(Math.cos(planetObj.userData.angle) * data.distance, 0, Math.sin(planetObj.userData.angle) * data.distance);
                solarSystemGroup.add(planetObj);
                planetMeshes.push(planetObj);
                if(data.distance > 0) createOrbitDust(data.distance);
            });

            createBackgroundStars();
            window.addEventListener('resize', onResize);
        }

        // --- PARTICLE CREATION (Updated for new shader attributes) ---
        function createPlanet(data, uniforms) {
            const group = new THREE.Group();
            const count = data.name === "Sun" ? 8000 : 2500;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const originalPositions = []; // æ–°å¢ï¼šå­˜å‚¨åˆå§‹ä½ç½®ç”¨äºæ¢å¤
            const colors = [];
            const sizes = [];
            const variations = [];

            const colorBase = new THREE.Color(data.color[0], data.color[1], data.color[2]);
            const hsl = {}; colorBase.getHSL(hsl);

            for (let i = 0; i < count; i++) {
                // ä½¿ç”¨çƒä½“åˆ†å¸ƒï¼Œä½†ç¨å¾®å‹æ‰ä¸€ç‚¹ç‚¹
                const r = data.radius * (0.8 + Math.random() * 0.4);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(Math.random() * 2 - 1);

                let x = r * Math.sin(phi) * Math.cos(theta);
                let y = r * Math.sin(phi) * Math.sin(theta) * 0.9; // ç•¥å¾®å‹æ‰
                let z = r * Math.cos(phi);

                // å¤ªé˜³æœ‰æ›´åšçš„å¤§æ°”å±‚
                if (data.name === "Sun" && Math.random() > 0.6) {
                    const rAtm = data.radius * (1.2 + Math.random() * 0.8);
                     x = rAtm * Math.sin(phi) * Math.cos(theta);
                     y = rAtm * Math.sin(phi) * Math.sin(theta);
                     z = rAtm * Math.cos(phi);
                }

                positions.push(x, y, z);
                originalPositions.push(x, y, z); // è®°å½•åŸå§‹ä½ç½®

                // é¢œè‰²å˜å¥
                const c = new THREE.Color().setHSL(hsl.h + (Math.random()-0.5)*0.1, hsl.s, hsl.l + (Math.random()-0.5)*0.2);
                colors.push(c.r, c.g, c.b);
                // å°ºå¯¸å˜å¥
                sizes.push(data.radius * (0.05 + Math.random() * 0.1));
                variations.push(Math.random());
            }
            
            // åœŸæ˜Ÿç¯ (ç®€åŒ–ä¸ºåœ†ç›˜ç²’å­)
            if(data.hasRings) {
                for(let i=0; i<1200; i++) {
                    const r = data.radius * (1.4 + Math.random() * 1.8);
                    const theta = Math.random() * Math.PI * 2;
                    const x = r * Math.cos(theta);
                    const y = (Math.random()-0.5) * 0.3;
                    const z = r * Math.sin(theta);
                    positions.push(x,y,z); originalPositions.push(x,y,z);
                    colors.push(colorBase.r*0.7, colorBase.g*0.7, colorBase.b*0.8);
                    sizes.push(0.4); variations.push(Math.random());
                }
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('originalPos', new THREE.Float32BufferAttribute(originalPositions, 3)); // Pass original pos
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            geometry.setAttribute('variation', new THREE.Float32BufferAttribute(variations, 1));

            const material = new THREE.ShaderMaterial({
                uniforms: uniforms,
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                blending: THREE.AdditiveBlending, // å…³é”®ï¼šåŠ æ³•æ··åˆåˆ›é€ å‘å…‰æ„Ÿ
                depthTest: false,
                transparent: true,
                vertexColors: true
            });
            group.add(new THREE.Points(geometry, material));
            return group;
        }

        function createOrbitDust(radius) {
            const geometry = new THREE.BufferGeometry();
            const positions = []; const colors = [];
            for (let i = 0; i < 400; i++) {
                const angle = (i / 400) * Math.PI * 2;
                const r = radius + (Math.random() - 0.5) * 1.5;
                positions.push(Math.cos(angle) * r, (Math.random()-0.5)*0.8, Math.sin(angle) * r);
                colors.push(0.3, 0.3, 0.35);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const material = new THREE.PointsMaterial({ size: 0.4, vertexColors: true, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending });
            orbitSystemGroup.add(new THREE.Points(geometry, material));
        }

        function createBackgroundStars() {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            for (let i = 0; i < 3000; i++) {
                const r = 500 + Math.random() * 500;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(Math.random() * 2 - 1);
                positions.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            scene.add(new THREE.Points(geometry, new THREE.PointsMaterial({ color: 0x666666, size: 1.2, transparent: true, opacity: 0.6 })));
        }

        // åˆ¶ä½œæ›´æŸ”å’Œã€ä¸­å¿ƒå‘äº®çš„çº¹ç†
        function createSoftTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const g = ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0, 'rgba(255,255,255,1)');
            g.addColorStop(0.3, 'rgba(255,255,255,0.4)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g;
            ctx.fillRect(0,0,64,64);
            const tex = new THREE.Texture(canvas);
            tex.needsUpdate = true;
            return tex;
        }

        // --- UI & INTERACTION ---
        function createUI() {
            const menu = document.getElementById('planet-menu');
            PLANETS_DB.forEach((p, i) => {
                const btn = document.createElement('div');
                btn.className = 'planet-btn'; btn.id = `btn-${i}`;
                btn.innerHTML = `<span>${p.name}</span><span style="font-size:10px; opacity:0.3">â—‹</span>`;
                btn.onclick = () => focusPlanet(i);
                menu.appendChild(btn);
            });
        }

        window.focusPlanet = function(index) {
            focusedPlanetIdx = index;
            document.querySelectorAll('.planet-btn').forEach(b => b.classList.remove('active'));
            
            if(index === -1) {
                document.querySelector('.planet-btn').classList.add('active');
                toggleInfoPanel(false);
                // æ¢å¤æ€»è§ˆè§†è§’
                targetCamPos.set(0, 70, 220);
                targetLookAt.set(0, 0, 0);
                globalSpeed = 1.0;
                controls.autoRotate = true; // æ¢å¤è‡ªåŠ¨æ—‹è½¬
                controls.minDistance = 20;
            } else {
                document.getElementById(`btn-${index}`).classList.add('active');
                updateInfoPanel(index);
                globalSpeed = 0.1; // èšç„¦æ—¶æ—¶é—´å˜æ…¢
                controls.autoRotate = false; // èšç„¦æ—¶åœæ­¢è‡ªåŠ¨æ—‹è½¬ï¼Œäº¤ç»™ç”¨æˆ·æ§åˆ¶
                
                // --- éœ€æ±‚ 3: é•œå¤´å±…ä¸­èšç„¦ ---
                const targetMesh = planetMeshes[index];
                const planetPos = targetMesh.position.clone();
                const radius = PLANETS_DB[index].radius;
                
                // è®¡ç®—æ‘„åƒæœºä½ç½®ï¼šä½äºè¡Œæ˜Ÿå’Œå¤ªé˜³è¿çº¿ä¸Šï¼Œé è¿‘æ—¥çƒä¾§
                // è¿™æ ·èƒ½çœ‹åˆ°è¢«å¤ªé˜³ç…§äº®çš„ä¸€é¢
                const vecFromSun = planetPos.clone().normalize();
                // è·ç¦»å–å†³äºè¡Œæ˜ŸåŠå¾„ï¼Œç¡®ä¿å¡«æ»¡å±å¹•ä¸­å¿ƒ
                const viewDistance = radius * 5.0 + 15; 
                const newCamPos = planetPos.clone().add(vecFromSun.multiplyScalar(-viewDistance));
                // ç¨å¾®æŠ¬é«˜ä¸€ç‚¹è§†è§’
                newCamPos.y += viewDistance * 0.2;

                targetCamPos.copy(newCamPos);
                targetLookAt.copy(planetPos); // ç›®æ ‡ç‚¹é”å®šè¡Œæ˜Ÿä¸­å¿ƒ

                // å…è®¸åœ¨èšç„¦æ—¶æ‹‰å¾—æ›´è¿‘
                controls.minDistance = radius * 2.0;
            }
        };

        function updateInfoPanel(index) {
            const data = PLANETS_DB[index];
            document.getElementById('info-name').innerText = data.name;
            document.getElementById('info-type').innerText = data.type;
            document.getElementById('info-desc').innerText = data.desc;
            document.getElementById('info-dia').innerText = data.data.dia;
            document.getElementById('info-temp').innerText = data.data.temp;
            toggleInfoPanel(true);
        }

        window.toggleInfoPanel = function(forceState) {
            const panel = document.getElementById('info-panel');
            if (typeof forceState !== 'undefined') {
                panel.classList.toggle('visible', forceState);
            } else {
                panel.classList.toggle('visible');
            }
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;
            uniforms.uTime.value = time;

            // å¹³æ»‘è¿‡æ¸¡æ¡æ‹³å€¼
            uniforms.uFist.value += (handFistValue - uniforms.uFist.value) * 0.1;

            // è¡Œæ˜Ÿå…¬è½¬
            planetMeshes.forEach((mesh, i) => {
                if (PLANETS_DB[i].distance === 0) return;
                mesh.userData.angle += mesh.userData.speed * globalSpeed;
                mesh.position.set(
                    Math.cos(mesh.userData.angle) * mesh.userData.distance,
                    0,
                    Math.sin(mesh.userData.angle) * mesh.userData.distance
                );
                // è‡ªè½¬ï¼ˆè§†è§‰æ•ˆæœï¼‰
                mesh.rotation.y += 0.002;
            });

            // æ‘„åƒæœºå¹³æ»‘ç§»åŠ¨ (ç®€å•çš„ LERP)
            // æ³¨æ„ï¼šå½“ OrbitControls æ¿€æ´»æ—¶ï¼Œå®ƒä¼šè¦†ç›– camera.lookAt
            // æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ›´æ–° controls.target
            currentCamPos.lerp(targetCamPos, 0.04);
            currentLookAt.lerp(targetLookAt, 0.04);
            
            camera.position.copy(currentCamPos);
            controls.target.copy(currentLookAt);
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();

            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- MEDIA PIPE ---
        async function startCamera() {
            const video = document.getElementById('input-video');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    statusDot.classList.add('active');
                    statusText.innerText = "Gesture Active";
                    const lm = results.multiHandLandmarks[0];
                    
                    // ç®€å•çš„æ¡æ‹³æ£€æµ‹ï¼šæ£€æŸ¥æŒ‡å°–æ˜¯å¦é è¿‘æ‰‹æŒæ ¹éƒ¨
                    // æ¯”è¾ƒé£ŸæŒ‡æŒ‡å°–(8)å’Œé£ŸæŒ‡æ ¹éƒ¨(5)ä¸æ‰‹è…•(0)çš„è·ç¦»æ¯”
                    const wrist = lm[0];
                    const indexTip = lm[8];
                    const indexBase = lm[5];
                    const tipDist = Math.hypot(indexTip.x - wrist.x, indexTip.y - wrist.y);
                    const baseDist = Math.hypot(indexBase.x - wrist.x, indexBase.y - wrist.y);
                    
                    // å¦‚æœæŒ‡å°–è·ç¦»å°äºæ ¹éƒ¨è·ç¦»çš„æŸç§æ¯”ä¾‹ï¼Œè®¤ä¸ºæ˜¯æ¡æ‹³
                    // 1.0 = å®Œå…¨æ¡ç´§ (èšåˆ), 0.0 = å®Œå…¨å¼ å¼€ (ç»½æ”¾)
                    if (tipDist < baseDist * 0.9) {
                         handFistValue = 1.0; // æ¡æ‹³ï¼šèšåˆ
                    } else {
                         handFistValue = 0.0; // å¼ å¼€ï¼šç»½æ”¾
                    }

                } else {
                    statusDot.classList.remove('active');
                    statusText.innerText = "Scanning hand...";
                    handFistValue = 0.0; // é»˜è®¤å¼ å¼€
                }
            });

            const cameraUtils = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            await cameraUtils.start();
        }
    </script>
</body>
</html>
